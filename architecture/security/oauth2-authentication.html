<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Backend ¬∑
security/oauth2-authentication ¬∑ Smart Supply Pro Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS lives under /templates on GitHub Pages for inventory-service repo -->
  <link rel="stylesheet" href="/inventory-service/templates/docs.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a href="/inventory-service/" class="logo">üì¶ Smart Supply Pro Docs</a>
      <nav class="nav">
      <a href="/inventory-service/architecture/index.html">Backend Architecture</a>
      <a href="/inventory-service/architecture/overview-de.html">Backend Architektur Deutsch</a>
      <a href="/inventory-service/frontend/architecture/index.html">Frontend Architecture</a>
      <a href="/inventory-service/backend/api/index.html">Backend API</a>
      <a href="/inventory-service/frontend/api/index.html">Frontend API</a>
      <a href="/inventory-service/backend/coverage/index.html">Backend Coverage</a>  
      <a href="/inventory-service/frontend/coverage/index.html">Frontend Coverage</a>
      </nav>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <h2>Backend</h2>
      <ul>
        <li><a href="/inventory-service/architecture/overview.html">Architecture Overview</a></li>
        <li><a href="/inventory-service/architecture/overview-de.html">Architektur-√úberblick</a></li>
        <li><a href="/inventory-service/architecture/layers/overview.html">Layers</a></li>
        <li><a href="/inventory-service/architecture/model/index.html">Data Models</a></li>
        <li><a href="/inventory-service/architecture/enums/index.html">Enums</a></li>
        <li><a href="/inventory-service/architecture/dto/index.html">DTOs</a></li>
        <li><a href="/inventory-service/architecture/config/index.html">Config</a></li>
        <li><a href="/inventory-service/architecture/controller/index.html">Controllers</a></li>
        <li><a href="/inventory-service/architecture/security/index.html">Security</a></li>
        <li><a href="/inventory-service/architecture/deployment/index.html">Deployment</a></li>
        <li><a href="/inventory-service/architecture/exception/index.html">Exception Handling</a></li>
        <li><a href="/inventory-service/architecture/integration/index.html">Integration</a></li>
        <li><a href="/inventory-service/architecture/repository/index.html">Repository</a></li>
        <li><a href="/inventory-service/architecture/resources/index.html">Resources</a></li>
        <li><a href="/inventory-service/architecture/validation/index.html">Validation</a></li>
        <li><a href="/inventory-service/architecture/testing/index.html">Testing</a></li>
        <li><a href="/inventory-service/architecture/diagrams/index.html">Diagrams</a></li>
      </ul>

      <h2>Frontend</h2>
      <ul>
        <h3>Docs coming soon</h3>
        <!-- Future <li><a href="/inventory-service/frontend/architecture/overview.html">Architecture Overview</a></li> -->
      </ul>

      <h2>Quality</h2>
      <ul>
        <li><a href="/inventory-service/backend/api/index.html">API Reference</a></li>
        <li><a href="/inventory-service/backend/coverage/index.html">JaCoCo Coverage</a></li>
      </ul>
    </aside>

    <section class="content">
            <nav class="toc">
        <h2>On this page</h2>
        <ul>
        <li><a href="#oauth2-authentication"
        id="toc-oauth2-authentication">OAuth2 Authentication</a>
        <ul>
        <li><a href="#overview" id="toc-overview">Overview</a></li>
        <li><a href="#authentication-flow"
        id="toc-authentication-flow">Authentication Flow</a>
        <ul>
        <li><a href="#step-1-user-initiates-login"
        id="toc-step-1-user-initiates-login">Step 1: User Initiates
        Login</a></li>
        <li><a href="#step-2-user-grants-permissions"
        id="toc-step-2-user-grants-permissions">Step 2: User Grants
        Permissions</a></li>
        <li><a href="#step-3-authorization-code-callback"
        id="toc-step-3-authorization-code-callback">Step 3:
        Authorization Code Callback</a></li>
        <li><a href="#step-4-exchange-code-for-token"
        id="toc-step-4-exchange-code-for-token">Step 4: Exchange Code
        for Token</a></li>
        <li><a href="#step-5-local-user-provisioning"
        id="toc-step-5-local-user-provisioning">Step 5: Local User
        Provisioning</a></li>
        <li><a href="#step-6-session-established"
        id="toc-step-6-session-established">Step 6: Session
        Established</a></li>
        <li><a href="#step-7-redirect-to-frontend"
        id="toc-step-7-redirect-to-frontend">Step 7: Redirect to
        Frontend</a></li>
        </ul></li>
        <li><a href="#configuration"
        id="toc-configuration">Configuration</a>
        <ul>
        <li><a href="#application-properties"
        id="toc-application-properties">Application Properties</a></li>
        <li><a href="#environment-variables"
        id="toc-environment-variables">Environment Variables</a></li>
        </ul></li>
        <li><a href="#components" id="toc-components">Components</a>
        <ul>
        <li><a href="#customoauth2userservice"
        id="toc-customoauth2userservice">CustomOAuth2UserService</a></li>
        <li><a href="#customoidcuserservice"
        id="toc-customoidcuserservice">CustomOidcUserService</a></li>
        <li><a href="#oauth2loginsuccesshandler"
        id="toc-oauth2loginsuccesshandler">OAuth2LoginSuccessHandler</a></li>
        <li><a href="#cookieoauth2authorizationrequestrepository"
        id="toc-cookieoauth2authorizationrequestrepository">CookieOAuth2AuthorizationRequestRepository</a></li>
        </ul></li>
        <li><a href="#cors-configuration-for-oauth2"
        id="toc-cors-configuration-for-oauth2">CORS Configuration for
        OAuth2</a></li>
        <li><a href="#logout-flow" id="toc-logout-flow">Logout Flow</a>
        <ul>
        <li><a href="#user-initiated-logout"
        id="toc-user-initiated-logout">User-Initiated Logout</a></li>
        <li><a href="#session-timeout" id="toc-session-timeout">Session
        Timeout</a></li>
        </ul></li>
        <li><a href="#error-handling" id="toc-error-handling">Error
        Handling</a>
        <ul>
        <li><a href="#invalid-oauth2-provider-credentials"
        id="toc-invalid-oauth2-provider-credentials">Invalid OAuth2
        Provider Credentials</a></li>
        <li><a href="#user-provisioning-failure"
        id="toc-user-provisioning-failure">User Provisioning
        Failure</a></li>
        </ul></li>
        <li><a href="#security-considerations"
        id="toc-security-considerations">Security
        Considerations</a></li>
        <li><a href="#related-documentation"
        id="toc-related-documentation">Related Documentation</a></li>
        </ul></li>
        </ul>
      </nav>
      
      <article class="doc-body">
        <p><a href="./index.html">‚¨ÖÔ∏è Back to Security Index</a></p>
        <h1 id="oauth2-authentication">OAuth2 Authentication</h1>
        <h2 id="overview">Overview</h2>
        <p>Smart Supply Pro implements <strong>OAuth2
        authentication</strong> with support for Google and other OpenID
        Connect (OIDC) providers. The system features automatic user
        provisioning, secure session management, and stateless
        authorization request handling.</p>
        <hr />
        <h2 id="authentication-flow">Authentication Flow</h2>
        <h3 id="step-1-user-initiates-login">Step 1: User Initiates
        Login</h3>
        <p>User clicks ‚ÄúLogin with Google‚Äù button on frontend:</p>
        <pre><code>Frontend: https://inventory.example.com/login
‚Üí Redirects to: https://accounts.google.com/o/oauth2/v2/auth
  ?client_id=&lt;CLIENT_ID&gt;
  &amp;response_type=code
  &amp;scope=openid+profile+email
  &amp;redirect_uri=&lt;backend&gt;/login/oauth2/code/google</code></pre>
        <h3 id="step-2-user-grants-permissions">Step 2: User Grants
        Permissions</h3>
        <p>Google displays consent screen. User approves access to email
        and profile.</p>
        <h3 id="step-3-authorization-code-callback">Step 3:
        Authorization Code Callback</h3>
        <p>Google redirects to backend:</p>
        <pre><code>Backend: GET /login/oauth2/code/google?code=&lt;AUTH_CODE&gt;&amp;state=&lt;STATE&gt;</code></pre>
        <h3 id="step-4-exchange-code-for-token">Step 4: Exchange Code
        for Token</h3>
        <p>Backend exchanges authorization code for ID token:</p>
        <pre><code>POST https://oauth2.googleapis.com/token
  grant_type=authorization_code
  code=&lt;AUTH_CODE&gt;
  client_id=&lt;CLIENT_ID&gt;
  client_secret=&lt;CLIENT_SECRET&gt;
  redirect_uri=&lt;backend&gt;/login/oauth2/code/google

Response: {
  &quot;id_token&quot;: &quot;&lt;JWT&gt;&quot;,
  &quot;access_token&quot;: &quot;&lt;TOKEN&gt;&quot;,
  &quot;token_type&quot;: &quot;Bearer&quot;,
  &quot;expires_in&quot;: 3600
}</code></pre>
        <h3 id="step-5-local-user-provisioning">Step 5: Local User
        Provisioning</h3>
        <p>Backend decodes ID token and provisions local user:</p>
        <div class="sourceCode" id="cb4"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// CustomOAuth2UserService.loadUser()</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fl">1.</span> Decode JWT and extract <span class="fu">claims</span> <span class="op">(</span>email<span class="op">,</span> name<span class="op">,</span> sub<span class="op">)</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="fl">2.</span> Check <span class="cf">if</span> user exists in local database by email</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fl">3.</span> If not found<span class="op">,</span> create <span class="kw">new</span> AppUser with<span class="op">:</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>   <span class="op">-</span> <span class="fu">email</span> <span class="op">(</span>unique identifier<span class="op">)</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>   <span class="op">-</span> <span class="fu">name</span> <span class="op">(</span>from OAuth2<span class="op">)</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>   <span class="op">-</span> <span class="fu">role</span> <span class="op">(</span>ADMIN <span class="cf">if</span> email in APP_ADMIN_EMAILS<span class="op">,</span> <span class="cf">else</span> USER<span class="op">)</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>   <span class="op">-</span> createdAt timestamp</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fl">4.</span> If found<span class="op">,</span> perform <span class="st">&quot;role healing&quot;</span> <span class="op">(</span>update role <span class="cf">if</span> allow<span class="op">-</span>list changed<span class="op">)</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fl">5.</span> Return OAuth2User with ROLE_<span class="op">*</span> authority</span></code></pre></div>
        <h3 id="step-6-session-established">Step 6: Session
        Established</h3>
        <p>Backend sets secure HTTP-only cookie:</p>
        <pre><code>Set-Cookie: SESSION=&lt;session-id&gt;; Path=/; SameSite=None; Secure; HttpOnly</code></pre>
        <h3 id="step-7-redirect-to-frontend">Step 7: Redirect to
        Frontend</h3>
        <p>Backend redirects to frontend landing page:</p>
        <pre><code>302 Redirect: https://inventory.example.com/auth</code></pre>
        <hr />
        <h2 id="configuration">Configuration</h2>
        <h3 id="application-properties">Application Properties</h3>
        <p><strong>application.yml:</strong></p>
        <div class="sourceCode" id="cb7"><pre
        class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">spring</span><span class="kw">:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">security</span><span class="kw">:</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="at">    </span><span class="fu">oauth2</span><span class="kw">:</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="at">      </span><span class="fu">client</span><span class="kw">:</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">registration</span><span class="kw">:</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">google</span><span class="kw">:</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">client-id</span><span class="kw">:</span><span class="at"> ${SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID}</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">client-secret</span><span class="kw">:</span><span class="at"> ${SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET}</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">redirect-uri</span><span class="kw">:</span><span class="at"> </span><span class="st">&quot;{baseUrl}/login/oauth2/code/{registrationId}&quot;</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">scope</span><span class="kw">:</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> openid</span><span class="co">          # Request ID token (JWT)</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> profile</span><span class="co">         # Request name and picture</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="at">              </span><span class="kw">-</span><span class="at"> email</span><span class="co">           # Request email address</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="at">        </span><span class="fu">provider</span><span class="kw">:</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="at">          </span><span class="fu">google</span><span class="kw">:</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">authorization-uri</span><span class="kw">:</span><span class="at"> https://accounts.google.com/o/oauth2/v2/auth</span></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">token-uri</span><span class="kw">:</span><span class="at"> https://oauth2.googleapis.com/token</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="at">            </span><span class="fu">user-info-uri</span><span class="kw">:</span><span class="at"> https://www.googleapis.com/oauth2/v3/userinfo</span></span></code></pre></div>
        <h3 id="environment-variables">Environment Variables</h3>
        <div class="sourceCode" id="cb8"><pre
        class="sourceCode bash"><code class="sourceCode bash"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># From Google Cloud Console (OAuth2 credential)</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="va">SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_ID</span><span class="op">=&lt;</span>your-client-id<span class="op">&gt;</span>.apps.googleusercontent.com</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="va">SPRING_SECURITY_OAUTH2_CLIENT_REGISTRATION_GOOGLE_CLIENT_SECRET</span><span class="op">=&lt;</span>your-client-secret<span class="op">&gt;</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Admin emails (comma-separated, case-insensitive)</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="va">APP_ADMIN_EMAILS</span><span class="op">=</span>admin@company.com, <span class="ex">supervisor@company.de</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Frontend URL for OAuth2 redirects</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="va">APP_FRONTEND_BASE_URL</span><span class="op">=</span>https://inventory.example.com</span></code></pre></div>
        <hr />
        <h2 id="components">Components</h2>
        <h3 id="customoauth2userservice">CustomOAuth2UserService</h3>
        <p><strong>Purpose:</strong> Loads OAuth2 user and provisions
        local user</p>
        <p><strong>Key Features:</strong> - Reads admin allow-list from
        <code>APP_ADMIN_EMAILS</code> env var - Creates AppUser on first
        login - Performs role healing (updates role if allow-list
        changed) - Returns OAuth2User with ROLE_* authorities</p>
        <p><strong>Code Example:</strong></p>
        <div class="sourceCode" id="cb9"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CustomOAuth2UserService <span class="kw">implements</span> OAuth2UserService<span class="op">&lt;</span>OAuth2UserRequest<span class="op">,</span> OAuth2User<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> OAuth2User <span class="fu">loadUser</span><span class="op">(</span>OAuth2UserRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Delegate to default service for upstream provider communication</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>        OAuth2User oauthUser <span class="op">=</span> <span class="kw">new</span> <span class="fu">DefaultOAuth2UserService</span><span class="op">().</span><span class="fu">loadUser</span><span class="op">(</span>request<span class="op">);</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Extract email and name</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> email <span class="op">=</span> oauthUser<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;email&quot;</span><span class="op">);</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> name <span class="op">=</span> oauthUser<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. Determine role from APP_ADMIN_EMAILS</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="dt">boolean</span> isAdmin <span class="op">=</span> <span class="fu">readAdminAllowlist</span><span class="op">().</span><span class="fu">contains</span><span class="op">(</span>email<span class="op">.</span><span class="fu">toLowerCase</span><span class="op">());</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Role</span> desiredRole <span class="op">=</span> isAdmin <span class="op">?</span> <span class="bu">Role</span><span class="op">.</span><span class="fu">ADMIN</span> <span class="op">:</span> <span class="bu">Role</span><span class="op">.</span><span class="fu">USER</span><span class="op">;</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. Create or find user</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        AppUser user <span class="op">=</span> userRepository<span class="op">.</span><span class="fu">findByEmail</span><span class="op">(</span>email<span class="op">)</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElseGet</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>                AppUser u <span class="op">=</span> <span class="kw">new</span> <span class="fu">AppUser</span><span class="op">();</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>                u<span class="op">.</span><span class="fu">setEmail</span><span class="op">(</span>email<span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>                u<span class="op">.</span><span class="fu">setName</span><span class="op">(</span>name<span class="op">);</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>                u<span class="op">.</span><span class="fu">setRole</span><span class="op">(</span>desiredRole<span class="op">);</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                u<span class="op">.</span><span class="fu">setCreatedAt</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> userRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>u<span class="op">);</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 5. Role healing: update if allow-list changed</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>user<span class="op">.</span><span class="fu">getRole</span><span class="op">()</span> <span class="op">!=</span> desiredRole<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>            user<span class="op">.</span><span class="fu">setRole</span><span class="op">(</span>desiredRole<span class="op">);</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            userRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>user<span class="op">);</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 6. Return OAuth2User with ROLE_* authority</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>        SimpleGrantedAuthority roleAuth <span class="op">=</span> </span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>            <span class="kw">new</span> <span class="fu">SimpleGrantedAuthority</span><span class="op">(</span><span class="st">&quot;ROLE_&quot;</span> <span class="op">+</span> user<span class="op">.</span><span class="fu">getRole</span><span class="op">().</span><span class="fu">name</span><span class="op">());</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Object</span><span class="op">&gt;</span> attrs <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;(</span>oauthUser<span class="op">.</span><span class="fu">getAttributes</span><span class="op">());</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>        attrs<span class="op">.</span><span class="fu">put</span><span class="op">(</span><span class="st">&quot;appRole&quot;</span><span class="op">,</span> user<span class="op">.</span><span class="fu">getRole</span><span class="op">().</span><span class="fu">name</span><span class="op">());</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="kw">new</span> <span class="fu">DefaultOAuth2User</span><span class="op">(</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Collections</span><span class="op">.</span><span class="fu">singletonList</span><span class="op">(</span>roleAuth<span class="op">),</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>            attrs<span class="op">,</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;email&quot;</span>  <span class="co">// name attribute for OAuth2User.getName()</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <h3 id="customoidcuserservice">CustomOidcUserService</h3>
        <p><strong>Purpose:</strong> OIDC-specific user loading for
        OpenID Connect providers (e.g., Google with ID token)</p>
        <p><strong>Difference from CustomOAuth2UserService:</strong> -
        Works with <code>OidcUserRequest</code> and
        <code>OidcUser</code> (includes ID token) - Validates JWT
        signature using provider‚Äôs public keys - More secure for
        providers supporting OIDC</p>
        <h3
        id="oauth2loginsuccesshandler">OAuth2LoginSuccessHandler</h3>
        <p><strong>Purpose:</strong> Post-authentication user
        provisioning and redirect</p>
        <p><strong>Features:</strong> - Prevents double-redirect via
        request attribute check - Validates return URLs against
        allow-list - Creates audit log entry - Redirects to frontend
        landing page or return URL</p>
        <p><strong>Code Example:</strong></p>
        <div class="sourceCode" id="cb10"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> OAuth2LoginSuccessHandler <span class="kw">extends</span> SimpleUrlAuthenticationSuccessHandler <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">onAuthenticationSuccess</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>                                        HttpServletResponse response<span class="op">,</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>                                        Authentication authentication<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 1. Check if already processed (prevent double-redirect)</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>request<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;OAUTH2_SUCCESS_REDIRECT_DONE&quot;</span><span class="op">)</span> <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span><span class="op">;</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        request<span class="op">.</span><span class="fu">setAttribute</span><span class="op">(</span><span class="st">&quot;OAUTH2_SUCCESS_REDIRECT_DONE&quot;</span><span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 2. Extract OAuth2 token and user info</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        OAuth2AuthenticationToken token <span class="op">=</span> <span class="op">(</span>OAuth2AuthenticationToken<span class="op">)</span> authentication<span class="op">;</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        OAuth2User principal <span class="op">=</span> token<span class="op">.</span><span class="fu">getPrincipal</span><span class="op">();</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> email <span class="op">=</span> principal<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;email&quot;</span><span class="op">);</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> name <span class="op">=</span> principal<span class="op">.</span><span class="fu">getAttribute</span><span class="op">(</span><span class="st">&quot;name&quot;</span><span class="op">);</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 3. User already provisioned by CustomOAuth2UserService</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create or update AppUser if needed</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        AppUser user <span class="op">=</span> userRepository<span class="op">.</span><span class="fu">findByEmail</span><span class="op">(</span>email<span class="op">)</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElseGet</span><span class="op">(()</span> <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                AppUser u <span class="op">=</span> <span class="kw">new</span> <span class="fu">AppUser</span><span class="op">();</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                u<span class="op">.</span><span class="fu">setEmail</span><span class="op">(</span>email<span class="op">);</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                u<span class="op">.</span><span class="fu">setName</span><span class="op">(</span>name <span class="op">!=</span> <span class="kw">null</span> <span class="op">?</span> name <span class="op">:</span> email<span class="op">);</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> userRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>u<span class="op">);</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 4. Audit log</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>        log<span class="op">.</span><span class="fu">info</span><span class="op">(</span><span class="st">&quot;Enterprise OAuth2: User {} authenticated successfully&quot;</span><span class="op">,</span> email<span class="op">);</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 5. Validate return URL and redirect</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> baseUrl <span class="op">=</span> props<span class="op">.</span><span class="fu">getFrontend</span><span class="op">().</span><span class="fu">getBaseUrl</span><span class="op">();</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> returnUrl <span class="op">=</span> request<span class="op">.</span><span class="fu">getParameter</span><span class="op">(</span><span class="st">&quot;return&quot;</span><span class="op">);</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> target <span class="op">=</span> baseUrl <span class="op">+</span> <span class="st">&quot;/auth&quot;</span><span class="op">;</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>returnUrl <span class="op">!=</span> <span class="kw">null</span> <span class="op">&amp;&amp;</span> returnUrl<span class="op">.</span><span class="fu">startsWith</span><span class="op">(</span>baseUrl<span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            target <span class="op">=</span> returnUrl<span class="op">;</span>  <span class="co">// Validated redirect</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>        <span class="fu">getRedirectStrategy</span><span class="op">().</span><span class="fu">sendRedirect</span><span class="op">(</span>request<span class="op">,</span> response<span class="op">,</span> target<span class="op">);</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <h3
        id="cookieoauth2authorizationrequestrepository">CookieOAuth2AuthorizationRequestRepository</h3>
        <p><strong>Purpose:</strong> Stateless OAuth2 authorization
        request persistence using secure cookies</p>
        <p><strong>Why Needed:</strong> - OAuth2 flow involves multiple
        requests over time - State parameter must be preserved across
        requests - Cookies provide stateless persistence (suitable for
        cloud/stateless deployments)</p>
        <p><strong>Security Features:</strong> - Serializes
        authorization request to JSON - Encodes to Base64 - Stores in
        secure, HTTP-only cookie - Validates CSRF token - Origin/domain
        validation</p>
        <p><strong>Code Example:</strong></p>
        <div class="sourceCode" id="cb11"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Component</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> CookieOAuth2AuthorizationRequestRepository </span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        <span class="kw">implements</span> AuthorizationRequestRepository<span class="op">&lt;</span>OAuth2AuthorizationRequest<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="bu">String</span> AUTH_REQUEST_COOKIE_NAME <span class="op">=</span> <span class="st">&quot;OAUTH2_AUTH_REQUEST&quot;</span><span class="op">;</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">static</span> <span class="dt">final</span> <span class="dt">int</span> COOKIE_MAX_AGE <span class="op">=</span> <span class="dv">180</span><span class="op">;</span>  <span class="co">// 3 minutes</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="dt">void</span> <span class="fu">saveAuthorizationRequest</span><span class="op">(</span>OAuth2AuthorizationRequest authRequest<span class="op">,</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>                                         HttpServletRequest request<span class="op">,</span></span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>                                         HttpServletResponse response<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> json <span class="op">=</span> <span class="fu">writeJson</span><span class="op">(</span>authRequest<span class="op">);</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> encoded <span class="op">=</span> Base64<span class="op">.</span><span class="fu">getUrlEncoder</span><span class="op">().</span><span class="fu">withoutPadding</span><span class="op">().</span><span class="fu">encodeToString</span><span class="op">(</span>json<span class="op">.</span><span class="fu">getBytes</span><span class="op">());</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create secure cookie</span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>        Cookie cookie <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cookie</span><span class="op">(</span>AUTH_REQUEST_COOKIE_NAME<span class="op">,</span> encoded<span class="op">);</span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setPath</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setSecure</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span>           <span class="co">// HTTPS only</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setHttpOnly</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span>         <span class="co">// No JavaScript access</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span>COOKIE_MAX_AGE<span class="op">);</span> <span class="co">// 3 minutes</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setSameSite</span><span class="op">(</span>CookieSameSite<span class="op">.</span><span class="fu">NONE</span><span class="op">);</span>  <span class="co">// Cross-site</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addCookie</span><span class="op">(</span>cookie<span class="op">);</span></span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> OAuth2AuthorizationRequest <span class="fu">loadAuthorizationRequest</span><span class="op">(</span>HttpServletRequest request<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="fu">read</span><span class="op">(</span>request<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Override</span></span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> OAuth2AuthorizationRequest <span class="fu">removeAuthorizationRequest</span><span class="op">(</span>HttpServletRequest request<span class="op">,</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>                                                                  HttpServletResponse response<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a>        OAuth2AuthorizationRequest existing <span class="op">=</span> <span class="fu">read</span><span class="op">(</span>request<span class="op">).</span><span class="fu">orElse</span><span class="op">(</span><span class="kw">null</span><span class="op">);</span></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Clear cookie</span></span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>        Cookie cookie <span class="op">=</span> <span class="kw">new</span> <span class="fu">Cookie</span><span class="op">(</span>AUTH_REQUEST_COOKIE_NAME<span class="op">,</span> <span class="st">&quot;&quot;</span><span class="op">);</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setPath</span><span class="op">(</span><span class="st">&quot;/&quot;</span><span class="op">);</span></span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>        cookie<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        response<span class="op">.</span><span class="fu">addCookie</span><span class="op">(</span>cookie<span class="op">);</span></span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> existing<span class="op">;</span></span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <hr />
        <h2 id="cors-configuration-for-oauth2">CORS Configuration for
        OAuth2</h2>
        <p>OAuth2 flows require cross-origin requests.
        Configuration:</p>
        <div class="sourceCode" id="cb12"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Bean</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> CorsConfigurationSource <span class="fu">corsConfigurationSource</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    CorsConfiguration config <span class="op">=</span> <span class="kw">new</span> <span class="fu">CorsConfiguration</span><span class="op">();</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="fu">setAllowedOrigins</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;http://localhost:5173&quot;</span><span class="op">,</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;https://localhost:5173&quot;</span><span class="op">,</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;https://inventory.example.com&quot;</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">));</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="fu">setAllowedMethods</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span><span class="st">&quot;GET&quot;</span><span class="op">,</span> <span class="st">&quot;POST&quot;</span><span class="op">,</span> <span class="st">&quot;PUT&quot;</span><span class="op">,</span> <span class="st">&quot;PATCH&quot;</span><span class="op">,</span> <span class="st">&quot;DELETE&quot;</span><span class="op">,</span> <span class="st">&quot;OPTIONS&quot;</span><span class="op">));</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="fu">setAllowedHeaders</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span><span class="st">&quot;*&quot;</span><span class="op">));</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="fu">setExposedHeaders</span><span class="op">(</span><span class="bu">Arrays</span><span class="op">.</span><span class="fu">asList</span><span class="op">(</span><span class="st">&quot;Set-Cookie&quot;</span><span class="op">));</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="fu">setAllowCredentials</span><span class="op">(</span><span class="kw">true</span><span class="op">);</span>      <span class="co">// Allow cookies in CORS</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    config<span class="op">.</span><span class="fu">setMaxAge</span><span class="op">(</span><span class="dv">3600L</span><span class="op">);</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>    UrlBasedCorsConfigurationSource source <span class="op">=</span> <span class="kw">new</span> <span class="fu">UrlBasedCorsConfigurationSource</span><span class="op">();</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    source<span class="op">.</span><span class="fu">registerCorsConfiguration</span><span class="op">(</span><span class="st">&quot;/**&quot;</span><span class="op">,</span> config<span class="op">);</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> source<span class="op">;</span></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <p><strong>Key Points:</strong> -
        <code>allowCredentials=true</code> allows cookies in
        cross-origin requests - <code>exposedHeaders</code> includes
        Set-Cookie for session management - <code>allowedOrigins</code>
        must match frontend deployment URL - SameSite=None requires both
        credentials and Secure flag</p>
        <hr />
        <h2 id="logout-flow">Logout Flow</h2>
        <h3 id="user-initiated-logout">User-Initiated Logout</h3>
        <pre><code>GET /logout?return=&lt;frontend-url&gt;
‚Üí Backend clears session:
   - Invalidates HttpSession
   - Deletes JSESSIONID and SESSION cookies
   - Logs out user
‚Üí Redirects to frontend logout success page</code></pre>
        <h3 id="session-timeout">Session Timeout</h3>
        <p>Backend enforces session timeout (default: 30 minutes
        idle).</p>
        <hr />
        <h2 id="error-handling">Error Handling</h2>
        <h3 id="invalid-oauth2-provider-credentials">Invalid OAuth2
        Provider Credentials</h3>
        <pre><code>OAuth2AuthenticationException: &quot;Email not provided by OAuth2 provider&quot;
‚Üí Redirects to: &lt;frontend-base-url&gt;/login?error=oauth</code></pre>
        <h3 id="user-provisioning-failure">User Provisioning
        Failure</h3>
        <pre><code>DataIntegrityViolationException on duplicate email:
‚Üí Backend retries with findByEmail
‚Üí Should succeed (user already created)
‚Üí Else: User experiences auth error (rare)</code></pre>
        <hr />
        <h2 id="security-considerations">Security Considerations</h2>
        <table>
        <thead>
        <tr class="header">
        <th>Threat</th>
        <th>Mitigation</th>
        </tr>
        </thead>
        <tbody>
        <tr class="odd">
        <td><strong>CSRF</strong></td>
        <td>State parameter validated, SameSite cookies</td>
        </tr>
        <tr class="even">
        <td><strong>Token Interception</strong></td>
        <td>HTTPS required, Secure cookie flag</td>
        </tr>
        <tr class="odd">
        <td><strong>XSS</strong></td>
        <td>HttpOnly cookies, no tokens in localStorage</td>
        </tr>
        <tr class="even">
        <td><strong>Phishing</strong></td>
        <td>OAuth2 provider handles user authentication</td>
        </tr>
        <tr class="odd">
        <td><strong>Password Breach</strong></td>
        <td>No passwords stored, delegated to provider</td>
        </tr>
        <tr class="even">
        <td><strong>Account Takeover</strong></td>
        <td>Role-based access control limits damage</td>
        </tr>
        </tbody>
        </table>
        <hr />
        <h2 id="related-documentation">Related Documentation</h2>
        <ul>
        <li><strong><a href="./index.html">Security Index</a></strong> -
        Master security overview</li>
        <li><strong><a href="./authorization-rbac.html">Authorization
        &amp; RBAC</a></strong> - Role-based access control</li>
        <li><strong><a
        href="../repository/app-user-repository.html">Repository -
        AppUserRepository</a></strong> - User data access patterns</li>
        </ul>
        <hr />
        <p><a href="./index.html">‚¨ÖÔ∏è Back to Security Index</a></p>
      </article>
    </section>
  </main>

  <footer class="footer">
    Smart Supply Pro ¬∑ Generated by Docs Pipeline
  </footer>

  <!-- Mermaid for diagrams in ```mermaid``` blocks -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: true });</script>
</body>
</html>
