<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Backend ¬∑
repository/stock-trend-analytics-repository ¬∑ Smart Supply Pro Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS lives under /templates on GitHub Pages for inventory-service repo -->
  <link rel="stylesheet" href="/inventory-service/templates/docs.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a href="/inventory-service/" class="logo">üì¶ Smart Supply Pro Docs</a>
      <nav class="nav">
      <a href="/inventory-service/architecture/index.html">Backend Architecture</a>
        <!-- Future: <a href="/inventory-service/frontend/architecture/overview.html">Frontend</a> -->
        <a href="/inventory-service/backend/api/index.html">Backend API</a>
        <!-- Future: <a href="/inventory-service/frontend/api/index.html">Frontend API</a> -->
        <a href="/inventory-service/backend/coverage/index.html">Backend Coverage</a>
        <!-- Future: <a href="/inventory-service/frontend/coverage/index.html">Frontend Coverage</a> -->
      </nav>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <h2>Backend</h2>
      <ul>
        <li><a href="/inventory-service/architecture/overview.html">Architecture Overview</a></li>
        <li><a href="/inventory-service/architecture/overview-de.html">Architektur-√úberblick</a></li>
        <li><a href="/inventory-service/architecture/layers/overview.html">Layers</a></li>
        <li><a href="/inventory-service/architecture/model/index.html">Data Models</a></li>
        <li><a href="/inventory-service/architecture/enums/index.html">Enums</a></li>
        <li><a href="/inventory-service/architecture/dto/index.html">DTOs</a></li>
        <li><a href="/inventory-service/architecture/config.html">Config</a></li>
        <li><a href="/inventory-service/architecture/controller/index.html">Controllers</a></li>
        <li><a href="/inventory-service/architecture/security.html">Security</a></li>
        <li><a href="/inventory-service/architecture/deployment.html">Deployment</a></li>
      </ul>

      <h2>Frontend</h2>
      <ul>
        <h3>Docs coming soon</h3>
        <!-- Future <li><a href="/inventory-service/frontend/architecture/overview.html">Architecture Overview</a></li> -->
      </ul>

      <h2>Quality</h2>
      <ul>
        <li><a href="/inventory-service/backend/api/index.html">API Reference</a></li>
        <li><a href="/inventory-service/backend/coverage/index.html">JaCoCo Coverage</a></li>
      </ul>
    </aside>

    <section class="content">
            <nav class="toc">
        <h2>On this page</h2>
        <ul>
        <li><a href="#stocktrendanalyticsrepository"
        id="toc-stocktrendanalyticsrepository">StockTrendAnalyticsRepository</a>
        <ul>
        <li><a href="#definition"
        id="toc-definition">Definition</a></li>
        <li><a href="#purpose" id="toc-purpose">Purpose</a></li>
        <li><a href="#query-methods" id="toc-query-methods">Query
        Methods</a>
        <ul>
        <li><a href="#getmonthlystockmovementitemid"
        id="toc-getmonthlystockmovementitemid">getMonthlyStockMovement(itemId)</a></li>
        <li><a href="#getdailystockvaluationdate"
        id="toc-getdailystockvaluationdate">getDailyStockValuation(date)</a></li>
        <li><a href="#getitempricetrenditemid-startdate-enddate"
        id="toc-getitempricetrenditemid-startdate-enddate">getItemPriceTrend(itemId,
        startDate, endDate)</a></li>
        </ul></li>
        <li><a href="#mixin-pattern-integration"
        id="toc-mixin-pattern-integration">Mixin Pattern
        Integration</a></li>
        <li><a href="#service-integration-pattern"
        id="toc-service-integration-pattern">Service Integration
        Pattern</a></li>
        <li><a href="#dashboard-integration"
        id="toc-dashboard-integration">Dashboard Integration</a></li>
        <li><a href="#testing" id="toc-testing">Testing</a></li>
        <li><a href="#performance-notes"
        id="toc-performance-notes">Performance Notes</a></li>
        <li><a href="#related-documentation"
        id="toc-related-documentation">Related Documentation</a></li>
        </ul></li>
        </ul>
      </nav>
      
      <article class="doc-body">
        <p><a href="./index.html">‚¨ÖÔ∏è Back to Repository Index</a></p>
        <h1
        id="stocktrendanalyticsrepository">StockTrendAnalyticsRepository</h1>
        <h2 id="definition">Definition</h2>
        <div class="sourceCode" id="cb1"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> StockTrendAnalyticsRepository <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">            DATETRUNC(&#39;month&#39;, sh.event_date) as month,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.item_id,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">            SUM(CASE WHEN sh.quantity_after &gt; sh.quantity_before THEN sh.quantity_after - sh.quantity_before ELSE 0 END) as inbound,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">            SUM(CASE WHEN sh.quantity_after &lt; sh.quantity_before THEN sh.quantity_before - sh.quantity_after ELSE 0 END) as outbound</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM stock_history sh</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE sh.item_id = :itemId</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="st">            AND sh.event_date &gt;= DATE_SUB(CURDATE(), INTERVAL 12 MONTH)</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">        GROUP BY DATETRUNC(&#39;month&#39;, sh.event_date), sh.item_id</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY month DESC</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">,</span> nativeQuery <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> <span class="fu">getMonthlyStockMovement</span><span class="op">(</span><span class="at">@Param</span><span class="op">(</span><span class="st">&quot;itemId&quot;</span><span class="op">)</span> <span class="bu">String</span> itemId<span class="op">);</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT </span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.event_date::date as event_date,</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="st">            i.price,</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.quantity_after,</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="st">            (sh.quantity_after * i.price) as daily_valuation</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM stock_history sh</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a><span class="st">        JOIN inventory_item i ON sh.item_id = i.id</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE sh.event_date::date = :date</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY sh.event_date DESC</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">,</span> nativeQuery <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> <span class="fu">getDailyStockValuation</span><span class="op">(</span><span class="at">@Param</span><span class="op">(</span><span class="st">&quot;date&quot;</span><span class="op">)</span> LocalDate date<span class="op">);</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT </span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.event_date::date as price_date,</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="st">            i.price,</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.quantity_after,</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="st">            LAG(i.price) OVER (PARTITION BY sh.item_id ORDER BY sh.event_date) as previous_price</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM stock_history sh</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="st">        JOIN inventory_item i ON sh.item_id = i.id</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE sh.item_id = :itemId</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="st">            AND sh.event_date BETWEEN :startDate AND :endDate</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY sh.event_date DESC</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">,</span> nativeQuery <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> <span class="fu">getItemPriceTrend</span><span class="op">(</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;itemId&quot;</span><span class="op">)</span> <span class="bu">String</span> itemId<span class="op">,</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;startDate&quot;</span><span class="op">)</span> LocalDateTime startDate<span class="op">,</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;endDate&quot;</span><span class="op">)</span> LocalDateTime endDate<span class="op">);</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <h2 id="purpose">Purpose</h2>
        <p>Custom analytics repository providing <strong>time-series
        trends</strong> for: - Monthly inventory movements
        (inbound/outbound) - Daily inventory valuation analysis - Item
        price history and trends - Supply chain velocity analysis -
        Financial inventory metrics</p>
        <hr />
        <h2 id="query-methods">Query Methods</h2>
        <h3
        id="getmonthlystockmovementitemid">getMonthlyStockMovement(itemId)</h3>
        <p><strong>Purpose:</strong> Analyze monthly inbound/outbound
        stock movements</p>
        <p><strong>Type:</strong> Native SQL with DATETRUNC and
        aggregations</p>
        <p><strong>Returns:</strong> List&lt;Object[]&gt; with [month,
        item_id, inbound, outbound]</p>
        <p><strong>Usage:</strong></p>
        <div class="sourceCode" id="cb2"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get 12-month trend for item</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> movement <span class="op">=</span> trendRepository</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getMonthlyStockMovement</span><span class="op">(</span>itemId<span class="op">);</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Monthly Stock Movements:&quot;</span><span class="op">);</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> row <span class="op">:</span> movement<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    LocalDateTime month <span class="op">=</span> <span class="op">(</span>LocalDateTime<span class="op">)</span> row<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> itemId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> row<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> inbound <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> outbound <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> netFlow <span class="op">=</span> inbound <span class="op">-</span> outbound<span class="op">;</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">%s</span><span class="st">: IN=</span><span class="sc">%d</span><span class="st">, OUT=</span><span class="sc">%d</span><span class="st">, NET=</span><span class="sc">%+d%n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>        month<span class="op">,</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>        inbound<span class="op">,</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>        outbound<span class="op">,</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>        netFlow</span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <p><strong>Use Cases:</strong> - Seasonal demand analysis -
        Inventory turnover rate - Supply chain velocity trends -
        Year-over-year comparisons - Reorder planning</p>
        <p><strong>Example Output:</strong></p>
        <pre><code>2024-12: IN=200, OUT=180, NET=+20
2024-11: IN=150, OUT=160, NET=-10
2024-10: IN=300, OUT=250, NET=+50</code></pre>
        <hr />
        <h3
        id="getdailystockvaluationdate">getDailyStockValuation(date)</h3>
        <p><strong>Purpose:</strong> Calculate daily inventory value by
        item</p>
        <p><strong>Type:</strong> Native SQL with JOIN</p>
        <p><strong>Returns:</strong> List&lt;Object[]&gt; with
        [event_date, price, quantity_after, daily_valuation]</p>
        <p><strong>Usage:</strong></p>
        <div class="sourceCode" id="cb4"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Get daily inventory valuation</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>LocalDate today <span class="op">=</span> LocalDate<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> valuations <span class="op">=</span> trendRepository</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getDailyStockValuation</span><span class="op">(</span>today<span class="op">);</span></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="bu">BigDecimal</span> totalValuation <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Daily Inventory Valuation:&quot;</span><span class="op">);</span></span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> row <span class="op">:</span> valuations<span class="op">)</span> <span class="op">{</span></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>    LocalDate date <span class="op">=</span> <span class="op">(</span>LocalDate<span class="op">)</span> row<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> price <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    totalValuation <span class="op">=</span> totalValuation<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span></span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">%s</span><span class="st">: </span><span class="sc">%d</span><span class="st"> units @ $</span><span class="sc">%.2f</span><span class="st"> = $</span><span class="sc">%.2f%n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>        date<span class="op">,</span></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        quantity<span class="op">,</span></span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a>        price<span class="op">,</span></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a>        value</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Total Inventory Value: $&quot;</span> <span class="op">+</span> totalValuation<span class="op">);</span></span></code></pre></div>
        <p><strong>Use Cases:</strong> - Daily inventory valuation
        reports - Balance sheet inventory accounting - Financial
        reporting - Working capital analysis</p>
        <hr />
        <h3
        id="getitempricetrenditemid-startdate-enddate">getItemPriceTrend(itemId,
        startDate, endDate)</h3>
        <p><strong>Purpose:</strong> Track price changes over time for
        item</p>
        <p><strong>Type:</strong> Native SQL with window function
        (LAG)</p>
        <p><strong>Returns:</strong> List&lt;Object[]&gt; with
        [price_date, price, quantity_after, previous_price]</p>
        <p><strong>Usage:</strong></p>
        <div class="sourceCode" id="cb5"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Analyze price trend for item over last 90 days</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LocalDateTime endDate <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>LocalDateTime startDate <span class="op">=</span> endDate<span class="op">.</span><span class="fu">minusDays</span><span class="op">(</span><span class="dv">90</span><span class="op">);</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> priceTrend <span class="op">=</span> trendRepository</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getItemPriceTrend</span><span class="op">(</span>itemId<span class="op">,</span> startDate<span class="op">,</span> endDate<span class="op">);</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">println</span><span class="op">(</span><span class="st">&quot;Price Trend Analysis:&quot;</span><span class="op">);</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> row <span class="op">:</span> priceTrend<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    LocalDate date <span class="op">=</span> <span class="op">(</span>LocalDate<span class="op">)</span> row<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> currentPrice <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> previousPrice <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> priceDirection <span class="op">=</span> <span class="st">&quot;‚Üí&quot;</span><span class="op">;</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>previousPrice <span class="op">!=</span> <span class="kw">null</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>currentPrice<span class="op">.</span><span class="fu">compareTo</span><span class="op">(</span>previousPrice<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>            priceDirection <span class="op">=</span> <span class="st">&quot;‚Üë (+$&quot;</span> <span class="op">+</span> currentPrice<span class="op">.</span><span class="fu">subtract</span><span class="op">(</span>previousPrice<span class="op">)</span> <span class="op">+</span> <span class="st">&quot;)&quot;</span><span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>currentPrice<span class="op">.</span><span class="fu">compareTo</span><span class="op">(</span>previousPrice<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>            priceDirection <span class="op">=</span> <span class="st">&quot;‚Üì (-$&quot;</span> <span class="op">+</span> previousPrice<span class="op">.</span><span class="fu">subtract</span><span class="op">(</span>currentPrice<span class="op">)</span> <span class="op">+</span> <span class="st">&quot;)&quot;</span><span class="op">;</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">%s</span><span class="st">: $</span><span class="sc">%.2f</span><span class="st"> </span><span class="sc">%s</span><span class="st"> (qty: </span><span class="sc">%d</span><span class="st">)</span><span class="sc">%n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        date<span class="op">,</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        currentPrice<span class="op">,</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>        priceDirection<span class="op">,</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>        quantity</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <p><strong>Window Function Rationale:</strong> - LAG() gets
        previous price without separate query - Enables price change
        detection - Efficient single-pass analysis</p>
        <p><strong>Use Cases:</strong> - Price elasticity analysis -
        Procurement cost trends - Supplier price negotiations - Cost of
        goods analysis</p>
        <hr />
        <h2 id="mixin-pattern-integration">Mixin Pattern
        Integration</h2>
        <p>StockTrendAnalyticsRepository is implemented as a
        <strong>mixin</strong> by: - <code>StockHistoryRepository</code>
        (main data source)</p>
        <div class="sourceCode" id="cb6"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> StockHistoryRepository <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>StockHistory<span class="op">,</span> <span class="bu">String</span><span class="op">&gt;,</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>                                               StockMetricsRepository<span class="op">,</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>                                               StockTrendAnalyticsRepository<span class="op">,</span>  <span class="co">// ‚Üê Mixin</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>                                               StockDetailQueryRepository <span class="op">{</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Additional query methods...</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <p>This allows StockHistoryRepository to expose trend analysis
        methods:</p>
        <div class="sourceCode" id="cb7"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Can call trend methods through StockHistoryRepository</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> movement <span class="op">=</span> stockHistoryRepository</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getMonthlyStockMovement</span><span class="op">(</span>itemId<span class="op">);</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> valuation <span class="op">=</span> stockHistoryRepository</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getDailyStockValuation</span><span class="op">(</span>LocalDate<span class="op">.</span><span class="fu">now</span><span class="op">());</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> priceTrend <span class="op">=</span> stockHistoryRepository</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>    <span class="op">.</span><span class="fu">getItemPriceTrend</span><span class="op">(</span>itemId<span class="op">,</span> startDate<span class="op">,</span> endDate<span class="op">);</span></span></code></pre></div>
        <hr />
        <h2 id="service-integration-pattern">Service Integration
        Pattern</h2>
        <div class="sourceCode" id="cb8"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> InventoryTrendAnalysisService <span class="op">{</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StockHistoryRepository stockHistoryRepository<span class="op">;</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Analyze item velocity and seasonal patterns</span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ItemTrendAnalysisDTO <span class="fu">analyzeItemTrends</span><span class="op">(</span><span class="bu">String</span> itemId<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> movements <span class="op">=</span> stockHistoryRepository</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getMonthlyStockMovement</span><span class="op">(</span>itemId<span class="op">);</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Calculate statistics</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> avgInbound <span class="op">=</span> movements<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapToInt</span><span class="op">(</span>row <span class="op">-&gt;</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">2</span><span class="op">])</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">average</span><span class="op">()</span></span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> avgOutbound <span class="op">=</span> movements<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">mapToInt</span><span class="op">(</span>row <span class="op">-&gt;</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">])</span></span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">average</span><span class="op">()</span></span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">orElse</span><span class="op">(</span><span class="fl">0.0</span><span class="op">);</span></span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>        <span class="dt">double</span> turnoverRate <span class="op">=</span> <span class="op">(</span>avgOutbound <span class="op">/</span> <span class="dv">30</span><span class="op">)</span> <span class="op">*</span> <span class="dv">12</span> <span class="op">*</span> <span class="dv">100</span><span class="op">;</span> <span class="co">// Annual turnover %</span></span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ItemTrendAnalysisDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>itemId<span class="op">)</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">avgMonthlyInbound</span><span class="op">(</span>avgInbound<span class="op">)</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">avgMonthlyOutbound</span><span class="op">(</span>avgOutbound<span class="op">)</span></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">annualTurnoverRate</span><span class="op">(</span>turnoverRate<span class="op">)</span></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">trend</span><span class="op">(</span><span class="fu">determineTrend</span><span class="op">(</span>movements<span class="op">))</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Get daily inventory valuation for financial reporting</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> InventoryValuationReportDTO <span class="fu">getDailyValuationReport</span><span class="op">(</span>LocalDate date<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> valuations <span class="op">=</span> stockHistoryRepository</span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getDailyStockValuation</span><span class="op">(</span>date<span class="op">);</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> totalValue <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> totalUnits <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> row <span class="op">:</span> valuations<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>            <span class="bu">BigDecimal</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>            <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> row<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>            totalValue <span class="op">=</span> totalValue<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a>            totalUnits <span class="op">+=</span> quantity<span class="op">;</span></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> InventoryValuationReportDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reportDate</span><span class="op">(</span>date<span class="op">)</span></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">totalInventoryValue</span><span class="op">(</span>totalValue<span class="op">)</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">totalUnits</span><span class="op">(</span>totalUnits<span class="op">)</span></span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">averageUnitValue</span><span class="op">(</span></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a>                totalUnits <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> </span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>                    totalValue<span class="op">.</span><span class="fu">divide</span><span class="op">(</span></span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>totalUnits<span class="op">),</span></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a>                        <span class="dv">2</span><span class="op">,</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">RoundingMode</span><span class="op">.</span><span class="fu">HALF_UP</span></span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>                    <span class="op">)</span> <span class="op">:</span> </span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span></span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemCount</span><span class="op">(</span>valuations<span class="op">.</span><span class="fu">size</span><span class="op">())</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Analyze price trends for procurement decisions</span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> PriceTrendAnalysisDTO <span class="fu">analyzePriceTrends</span><span class="op">(</span></span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId<span class="op">,</span></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> monthsBack</span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>        LocalDateTime endDate <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>        LocalDateTime startDate <span class="op">=</span> endDate<span class="op">.</span><span class="fu">minusMonths</span><span class="op">(</span>monthsBack<span class="op">);</span></span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> priceTrend <span class="op">=</span> stockHistoryRepository</span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getItemPriceTrend</span><span class="op">(</span>itemId<span class="op">,</span> startDate<span class="op">,</span> endDate<span class="op">);</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> minPrice <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> maxPrice <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> avgPrice <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>priceTrend<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span><span class="bu">BigDecimal</span><span class="op">&gt;</span> prices <span class="op">=</span> priceTrend<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">map</span><span class="op">(</span>row <span class="op">-&gt;</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a>            minPrice <span class="op">=</span> prices<span class="op">.</span><span class="fu">stream</span><span class="op">().</span><span class="fu">min</span><span class="op">(</span><span class="bu">Comparator</span><span class="op">.</span><span class="fu">naturalOrder</span><span class="op">()).</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">);</span></span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a>            maxPrice <span class="op">=</span> prices<span class="op">.</span><span class="fu">stream</span><span class="op">().</span><span class="fu">max</span><span class="op">(</span><span class="bu">Comparator</span><span class="op">.</span><span class="fu">naturalOrder</span><span class="op">()).</span><span class="fu">orElse</span><span class="op">(</span><span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">);</span></span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a>            avgPrice <span class="op">=</span> prices<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">reduce</span><span class="op">(</span><span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">,</span> <span class="bu">BigDecimal</span><span class="op">::</span>add<span class="op">)</span></span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">divide</span><span class="op">(</span><span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>prices<span class="op">.</span><span class="fu">size</span><span class="op">()),</span> <span class="dv">2</span><span class="op">,</span> <span class="bu">RoundingMode</span><span class="op">.</span><span class="fu">HALF_UP</span><span class="op">);</span></span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> trend <span class="op">=</span> <span class="st">&quot;STABLE&quot;</span><span class="op">;</span></span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(!</span>priceTrend<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb8-106"><a href="#cb8-106" aria-hidden="true" tabindex="-1"></a>            <span class="bu">BigDecimal</span> firstPrice <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> priceTrend<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb8-107"><a href="#cb8-107" aria-hidden="true" tabindex="-1"></a>            <span class="bu">BigDecimal</span> lastPrice <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> priceTrend<span class="op">.</span><span class="fu">get</span><span class="op">(</span>priceTrend<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">-</span> <span class="dv">1</span><span class="op">)[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb8-108"><a href="#cb8-108" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb8-109"><a href="#cb8-109" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> <span class="op">(</span>firstPrice<span class="op">.</span><span class="fu">compareTo</span><span class="op">(</span>lastPrice<span class="op">)</span> <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-110"><a href="#cb8-110" aria-hidden="true" tabindex="-1"></a>                trend <span class="op">=</span> <span class="st">&quot;DECLINING&quot;</span><span class="op">;</span></span>
<span id="cb8-111"><a href="#cb8-111" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>firstPrice<span class="op">.</span><span class="fu">compareTo</span><span class="op">(</span>lastPrice<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-112"><a href="#cb8-112" aria-hidden="true" tabindex="-1"></a>                trend <span class="op">=</span> <span class="st">&quot;INCREASING&quot;</span><span class="op">;</span></span>
<span id="cb8-113"><a href="#cb8-113" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb8-114"><a href="#cb8-114" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb8-115"><a href="#cb8-115" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-116"><a href="#cb8-116" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> PriceTrendAnalysisDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb8-117"><a href="#cb8-117" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>itemId<span class="op">)</span></span>
<span id="cb8-118"><a href="#cb8-118" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">periodMonths</span><span class="op">(</span>monthsBack<span class="op">)</span></span>
<span id="cb8-119"><a href="#cb8-119" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">minPrice</span><span class="op">(</span>minPrice<span class="op">)</span></span>
<span id="cb8-120"><a href="#cb8-120" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">maxPrice</span><span class="op">(</span>maxPrice<span class="op">)</span></span>
<span id="cb8-121"><a href="#cb8-121" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">avgPrice</span><span class="op">(</span>avgPrice<span class="op">)</span></span>
<span id="cb8-122"><a href="#cb8-122" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">priceRange</span><span class="op">(</span>maxPrice<span class="op">.</span><span class="fu">subtract</span><span class="op">(</span>minPrice<span class="op">))</span></span>
<span id="cb8-123"><a href="#cb8-123" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">trend</span><span class="op">(</span>trend<span class="op">)</span></span>
<span id="cb8-124"><a href="#cb8-124" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">dataPoints</span><span class="op">(</span>priceTrend<span class="op">.</span><span class="fu">size</span><span class="op">())</span></span>
<span id="cb8-125"><a href="#cb8-125" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb8-126"><a href="#cb8-126" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-127"><a href="#cb8-127" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb8-128"><a href="#cb8-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="bu">String</span> <span class="fu">determineTrend</span><span class="op">(</span><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> movements<span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-129"><a href="#cb8-129" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>movements<span class="op">.</span><span class="fu">isEmpty</span><span class="op">())</span> <span class="cf">return</span> <span class="st">&quot;UNKNOWN&quot;</span><span class="op">;</span></span>
<span id="cb8-130"><a href="#cb8-130" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-131"><a href="#cb8-131" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> inbound <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> movements<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb8-132"><a href="#cb8-132" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> outbound <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> movements<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb8-133"><a href="#cb8-133" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb8-134"><a href="#cb8-134" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>inbound <span class="op">&gt;</span> outbound <span class="op">*</span> <span class="fl">1.2</span><span class="op">)</span> <span class="cf">return</span> <span class="st">&quot;ACCUMULATING&quot;</span><span class="op">;</span></span>
<span id="cb8-135"><a href="#cb8-135" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>outbound <span class="op">&gt;</span> inbound <span class="op">*</span> <span class="fl">1.2</span><span class="op">)</span> <span class="cf">return</span> <span class="st">&quot;DEPLETING&quot;</span><span class="op">;</span></span>
<span id="cb8-136"><a href="#cb8-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="st">&quot;STABLE&quot;</span><span class="op">;</span></span>
<span id="cb8-137"><a href="#cb8-137" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-138"><a href="#cb8-138" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <hr />
        <h2 id="dashboard-integration">Dashboard Integration</h2>
        <p>Typical usage in analytics dashboards:</p>
        <div class="sourceCode" id="cb9"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">@RestController</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="at">@RequestMapping</span><span class="op">(</span><span class="st">&quot;/api/analytics&quot;</span><span class="op">)</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> AnalyticsController <span class="op">{</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> InventoryTrendAnalysisService trendService<span class="op">;</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/item/{id}/trends&quot;</span><span class="op">)</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>ItemTrendAnalysisDTO<span class="op">&gt;</span> <span class="fu">getItemTrends</span><span class="op">(</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">@PathVariable</span> <span class="bu">String</span> id</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        ItemTrendAnalysisDTO trends <span class="op">=</span> trendService<span class="op">.</span><span class="fu">analyzeItemTrends</span><span class="op">(</span>id<span class="op">);</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>trends<span class="op">);</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/valuation/daily&quot;</span><span class="op">)</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>InventoryValuationReportDTO<span class="op">&gt;</span> <span class="fu">getDailyValuation</span><span class="op">(</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">@RequestParam</span> <span class="at">@DateTimeFormat</span><span class="op">(</span>iso <span class="op">=</span> DateTimeFormat<span class="op">.</span><span class="fu">ISO</span><span class="op">.</span><span class="fu">DATE</span><span class="op">)</span> LocalDate date</span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        InventoryValuationReportDTO report <span class="op">=</span> trendService</span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getDailyValuationReport</span><span class="op">(</span>date<span class="op">);</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>report<span class="op">);</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">@GetMapping</span><span class="op">(</span><span class="st">&quot;/price-trends/{itemId}&quot;</span><span class="op">)</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> ResponseEntity<span class="op">&lt;</span>PriceTrendAnalysisDTO<span class="op">&gt;</span> <span class="fu">getPriceTrends</span><span class="op">(</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">@PathVariable</span> <span class="bu">String</span> itemId<span class="op">,</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">@RequestParam</span><span class="op">(</span>defaultValue <span class="op">=</span> <span class="st">&quot;12&quot;</span><span class="op">)</span> <span class="dt">int</span> months</span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>        PriceTrendAnalysisDTO trends <span class="op">=</span> trendService</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">analyzePriceTrends</span><span class="op">(</span>itemId<span class="op">,</span> months<span class="op">);</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> ResponseEntity<span class="op">.</span><span class="fu">ok</span><span class="op">(</span>trends<span class="op">);</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <hr />
        <h2 id="testing">Testing</h2>
        <div class="sourceCode" id="cb10"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@DataJpaTest</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StockTrendAnalyticsRepositoryTest <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StockHistoryRepository repository<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> InventoryItemRepository itemRepository<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">testMonthlyStockMovement</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId <span class="op">=</span> <span class="st">&quot;ITEM-001&quot;</span><span class="op">;</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>        LocalDateTime jan1 <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// January: 100 in, 50 out</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span><span class="fu">createEventAt</span><span class="op">(</span>itemId<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">100</span><span class="op">,</span> jan1<span class="op">.</span><span class="fu">plusHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)));</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span><span class="fu">createEventAt</span><span class="op">(</span>itemId<span class="op">,</span> <span class="dv">100</span><span class="op">,</span> <span class="dv">50</span><span class="op">,</span> jan1<span class="op">.</span><span class="fu">plusHours</span><span class="op">(</span><span class="dv">2</span><span class="op">)));</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// February: 200 in, 100 out</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        LocalDateTime feb1 <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">2</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span><span class="fu">createEventAt</span><span class="op">(</span>itemId<span class="op">,</span> <span class="dv">50</span><span class="op">,</span> <span class="dv">250</span><span class="op">,</span> feb1<span class="op">.</span><span class="fu">plusHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)));</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span><span class="fu">createEventAt</span><span class="op">(</span>itemId<span class="op">,</span> <span class="dv">250</span><span class="op">,</span> <span class="dv">150</span><span class="op">,</span> feb1<span class="op">.</span><span class="fu">plusHours</span><span class="op">(</span><span class="dv">2</span><span class="op">)));</span></span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> movements <span class="op">=</span> repository</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getMonthlyStockMovement</span><span class="op">(</span>itemId<span class="op">);</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertTrue</span><span class="op">(</span>movements<span class="op">.</span><span class="fu">size</span><span class="op">()</span> <span class="op">&gt;=</span> <span class="dv">2</span><span class="op">);</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">testDailyStockValuation</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Create item with price</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        InventoryItem item <span class="op">=</span> itemRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>            InventoryItem<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;ITEM-001&quot;</span><span class="op">)</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">name</span><span class="op">(</span><span class="st">&quot;Widget&quot;</span><span class="op">)</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">price</span><span class="op">(</span><span class="kw">new</span> <span class="bu">BigDecimal</span><span class="op">(</span><span class="st">&quot;10.00&quot;</span><span class="op">))</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">quantity</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">supplierId</span><span class="op">(</span><span class="st">&quot;SUP-001&quot;</span><span class="op">)</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">minimumQuantity</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">createdAt</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">())</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        LocalDateTime today <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">withHour</span><span class="op">(</span><span class="dv">0</span><span class="op">).</span><span class="fu">withMinute</span><span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>StockHistory<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;SH-001&quot;</span><span class="op">)</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>item<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityBefore</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityAfter</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reason</span><span class="op">(</span><span class="st">&quot;INITIAL&quot;</span><span class="op">)</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">eventDate</span><span class="op">(</span>today<span class="op">)</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">());</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> valuations <span class="op">=</span> repository</span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">getDailyStockValuation</span><span class="op">(</span>today<span class="op">.</span><span class="fu">toLocalDate</span><span class="op">());</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> valuations<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span><span class="kw">new</span> <span class="bu">BigDecimal</span><span class="op">(</span><span class="st">&quot;10.00&quot;</span><span class="op">),</span> valuations<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span><span class="dv">100</span><span class="op">,</span> valuations<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">2</span><span class="op">]);</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StockHistory <span class="fu">createEventAt</span><span class="op">(</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId<span class="op">,</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> before<span class="op">,</span></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> after<span class="op">,</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>        LocalDateTime date</span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> StockHistory<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="bu">UUID</span><span class="op">.</span><span class="fu">randomUUID</span><span class="op">().</span><span class="fu">toString</span><span class="op">())</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>itemId<span class="op">)</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityBefore</span><span class="op">(</span>before<span class="op">)</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityAfter</span><span class="op">(</span>after<span class="op">)</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reason</span><span class="op">(</span><span class="st">&quot;ADJUSTMENT&quot;</span><span class="op">)</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">eventDate</span><span class="op">(</span>date<span class="op">)</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <hr />
        <h2 id="performance-notes">Performance Notes</h2>
        <ul>
        <li><strong>DATETRUNC Aggregation:</strong> Efficient monthly
        grouping</li>
        <li><strong>Window Function (LAG):</strong> Single-pass price
        comparison</li>
        <li><strong>Date Filtering:</strong> Pre-filters to last 12
        months for movement query</li>
        <li><strong>JOIN with Inventory Items:</strong> Adds price
        column efficiently</li>
        <li><strong>Suitable for Monthly Reports:</strong> Not real-time
        (designed for reporting period)</li>
        </ul>
        <hr />
        <h2 id="related-documentation">Related Documentation</h2>
        <ul>
        <li><a href="./stock-history-repository.html">Stock History
        Repository</a> (implements mixin)</li>
        <li><a href="./stock-metrics-repository.html">Stock Metrics
        Repository</a></li>
        <li><a href="./stock-detail-query-repository.html">Stock Detail
        Query Repository</a></li>
        <li><a href="./index.html">Repository Layer Index</a></li>
        </ul>
        <hr />
        <p><a href="./index.html">‚¨ÖÔ∏è Back to Repository Index</a></p>
      </article>
    </section>
  </main>

  <footer class="footer">
    Smart Supply Pro ¬∑ Generated by Docs Pipeline
  </footer>

  <!-- Mermaid for diagrams in ```mermaid``` blocks -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: true });</script>
</body>
</html>
