<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Backend ¬∑
repository/stock-detail-query-repository ¬∑ Smart Supply Pro Docs</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CSS lives under /templates on GitHub Pages for inventory-service repo -->
  <link rel="stylesheet" href="/inventory-service/templates/docs.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-inner">
      <a href="/inventory-service/" class="logo">üì¶ Smart Supply Pro Docs</a>
      <nav class="nav">
      <a href="/inventory-service/architecture/index.html">Backend Architecture</a>
      <a href="/inventory-service/architecture/overview-de.html">Backend Architektur Deutsch</a>
      <a href="/inventory-service/frontend/architecture/index.html">Frontend Architecture</a>
      <a href="/inventory-service/backend/api/index.html">Backend API</a>
      <a href="/inventory-service/frontend/api/index.html">Frontend API</a>
      <a href="/inventory-service/backend/coverage/index.html">Backend Coverage</a>  
      <a href="/inventory-service/frontend/coverage/index.html">Frontend Coverage</a>
      </nav>
    </div>
  </header>

  <main class="layout">
    <aside class="sidebar">
      <h2>Backend</h2>
      <ul>
        <li><a href="/inventory-service/architecture/overview.html">Architecture Overview</a></li>
        <li><a href="/inventory-service/architecture/overview-de.html">Architektur-√úberblick</a></li>
        <li><a href="/inventory-service/architecture/layers/overview.html">Layers</a></li>
        <li><a href="/inventory-service/architecture/model/index.html">Data Models</a></li>
        <li><a href="/inventory-service/architecture/enums/index.html">Enums</a></li>
        <li><a href="/inventory-service/architecture/dto/index.html">DTOs</a></li>
        <li><a href="/inventory-service/architecture/config/index.html">Config</a></li>
        <li><a href="/inventory-service/architecture/controller/index.html">Controllers</a></li>
        <li><a href="/inventory-service/architecture/security/index.html">Security</a></li>
        <li><a href="/inventory-service/architecture/deployment/index.html">Deployment</a></li>
        <li><a href="/inventory-service/architecture/exception/index.html">Exception Handling</a></li>
        <li><a href="/inventory-service/architecture/integration/index.html">Integration</a></li>
        <li><a href="/inventory-service/architecture/repository/index.html">Repository</a></li>
        <li><a href="/inventory-service/architecture/resources/index.html">Resources</a></li>
        <li><a href="/inventory-service/architecture/validation/index.html">Validation</a></li>
        <li><a href="/inventory-service/architecture/testing/index.html">Testing</a></li>
        <li><a href="/inventory-service/architecture/diagrams/index.html">Diagrams</a></li>
      </ul>

      <h2>Frontend</h2>
      <ul>
        <h3>Docs coming soon</h3>
        <!-- Future <li><a href="/inventory-service/frontend/architecture/overview.html">Architecture Overview</a></li> -->
      </ul>

      <h2>Quality</h2>
      <ul>
        <li><a href="/inventory-service/backend/api/index.html">API Reference</a></li>
        <li><a href="/inventory-service/backend/coverage/index.html">JaCoCo Coverage</a></li>
      </ul>
    </aside>

    <section class="content">
            <nav class="toc">
        <h2>On this page</h2>
        <ul>
        <li><a href="#stockdetailqueryrepository"
        id="toc-stockdetailqueryrepository">StockDetailQueryRepository</a>
        <ul>
        <li><a href="#definition"
        id="toc-definition">Definition</a></li>
        <li><a href="#purpose" id="toc-purpose">Purpose</a></li>
        <li><a href="#query-methods" id="toc-query-methods">Query
        Methods</a>
        <ul>
        <li><a
        href="#searchstockupdatesitemid-supplier-reason-startdate-enddate"
        id="toc-searchstockupdatesitemid-supplier-reason-startdate-enddate">searchStockUpdates(itemId,
        supplier, reason, startDate, endDate)</a></li>
        <li><a href="#streameventsforwacdate-supplierid"
        id="toc-streameventsforwacdate-supplierid">streamEventsForWAC(date,
        supplierId)</a></li>
        </ul></li>
        <li><a href="#mixin-pattern-integration"
        id="toc-mixin-pattern-integration">Mixin Pattern
        Integration</a></li>
        <li><a href="#service-integration-pattern"
        id="toc-service-integration-pattern">Service Integration
        Pattern</a></li>
        <li><a href="#testing" id="toc-testing">Testing</a></li>
        <li><a href="#performance-notes"
        id="toc-performance-notes">Performance Notes</a></li>
        <li><a href="#related-documentation"
        id="toc-related-documentation">Related Documentation</a></li>
        </ul></li>
        </ul>
      </nav>
      
      <article class="doc-body">
        <p><a href="./index.html">‚¨ÖÔ∏è Back to Repository Index</a></p>
        <h1
        id="stockdetailqueryrepository">StockDetailQueryRepository</h1>
        <h2 id="definition">Definition</h2>
        <div class="sourceCode" id="cb1"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> StockDetailQueryRepository <span class="op">{</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT </span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.id,</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.item_id,</span></span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="st">            i.name,</span></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.quantity_before,</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.quantity_after,</span></span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.reason,</span></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.event_date,</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="st">            i.price,</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a><span class="st">            s.name as supplier_name</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM stock_history sh</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="st">        JOIN inventory_item i ON sh.item_id = i.id</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="st">        LEFT JOIN supplier s ON i.supplier_id = s.id</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE (:itemId IS NULL OR sh.item_id = :itemId)</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="st">            AND (:supplier IS NULL OR s.id = :supplier)</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="st">            AND (:reason IS NULL OR sh.reason = :reason)</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a><span class="st">            AND sh.event_date BETWEEN :startDate AND :endDate</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY sh.event_date DESC</span></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">,</span> nativeQuery <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> <span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;itemId&quot;</span><span class="op">)</span> <span class="bu">String</span> itemId<span class="op">,</span></span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;supplier&quot;</span><span class="op">)</span> <span class="bu">String</span> supplier<span class="op">,</span></span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;reason&quot;</span><span class="op">)</span> <span class="bu">String</span> reason<span class="op">,</span></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;startDate&quot;</span><span class="op">)</span> LocalDateTime startDate<span class="op">,</span></span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;endDate&quot;</span><span class="op">)</span> LocalDateTime endDate<span class="op">);</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Query</span><span class="op">(</span>value <span class="op">=</span> <span class="st">&quot;&quot;&quot;</span></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a><span class="st">        SELECT </span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.id,</span></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.item_id,</span></span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a><span class="st">            i.name,</span></span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.quantity_after,</span></span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a><span class="st">            i.price,</span></span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="st">            (sh.quantity_after * i.price) as total_value,</span></span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a><span class="st">            sh.event_date</span></span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="st">        FROM stock_history sh</span></span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a><span class="st">        JOIN inventory_item i ON sh.item_id = i.id</span></span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a><span class="st">        JOIN supplier s ON i.supplier_id = s.id</span></span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a><span class="st">        WHERE sh.event_date &gt;= :date</span></span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a><span class="st">            AND s.id = :supplierId</span></span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a><span class="st">            AND sh.quantity_after &gt; 0</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="st">        ORDER BY sh.event_date DESC</span></span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a><span class="st">        &quot;&quot;&quot;</span><span class="op">,</span> nativeQuery <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>    Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> <span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;date&quot;</span><span class="op">)</span> LocalDateTime date<span class="op">,</span></span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">@Param</span><span class="op">(</span><span class="st">&quot;supplierId&quot;</span><span class="op">)</span> <span class="bu">String</span> supplierId<span class="op">);</span></span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <h2 id="purpose">Purpose</h2>
        <p>Custom query repository providing <strong>advanced search and
        analytics</strong> for: - Multi-criteria stock history searches
        - Complex filtering across multiple entities - Weighted Average
        Cost (WAC) calculations - Detailed audit trail retrieval -
        Supply chain traceability</p>
        <hr />
        <h2 id="query-methods">Query Methods</h2>
        <h3
        id="searchstockupdatesitemid-supplier-reason-startdate-enddate">searchStockUpdates(itemId,
        supplier, reason, startDate, endDate)</h3>
        <p><strong>Purpose:</strong> Advanced search across stock
        history with optional filtering</p>
        <p><strong>Type:</strong> Native SQL with multi-table JOIN and
        optional filtering</p>
        <p><strong>Returns:</strong> List&lt;Object[]&gt; with [id,
        item_id, name, quantity_before, quantity_after, reason,
        event_date, price, supplier_name]</p>
        <p><strong>Usage:</strong></p>
        <div class="sourceCode" id="cb2"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Search all restock events from January</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> restockEvents <span class="op">=</span> repository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">null</span><span class="op">,</span>                          <span class="co">// Any item</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">null</span><span class="op">,</span>                          <span class="co">// Any supplier</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;RESTOCK&quot;</span><span class="op">,</span>                     <span class="co">// Only restocking</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">),</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">31</span><span class="op">,</span> <span class="dv">23</span><span class="op">,</span> <span class="dv">59</span><span class="op">)</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> event <span class="op">:</span> restockEvents<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> id <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">0</span><span class="op">];</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> itemId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> itemName <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> qtyBefore <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> event<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> qtyAfter <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> event<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> reason <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>    LocalDateTime eventDate <span class="op">=</span> <span class="op">(</span>LocalDateTime<span class="op">)</span> event<span class="op">[</span><span class="dv">6</span><span class="op">];</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> price <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> event<span class="op">[</span><span class="dv">7</span><span class="op">];</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">String</span> supplier <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">8</span><span class="op">];</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb2-21"><a href="#cb2-21" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span></span>
<span id="cb2-22"><a href="#cb2-22" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;</span><span class="sc">%s</span><span class="st">: </span><span class="sc">%s</span><span class="st"> from </span><span class="sc">%s</span><span class="st"> (</span><span class="sc">%d</span><span class="st">-&gt;</span><span class="sc">%d</span><span class="st"> units) at $</span><span class="sc">%.2f%n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb2-23"><a href="#cb2-23" aria-hidden="true" tabindex="-1"></a>        eventDate<span class="op">,</span></span>
<span id="cb2-24"><a href="#cb2-24" aria-hidden="true" tabindex="-1"></a>        itemName<span class="op">,</span></span>
<span id="cb2-25"><a href="#cb2-25" aria-hidden="true" tabindex="-1"></a>        supplier<span class="op">,</span></span>
<span id="cb2-26"><a href="#cb2-26" aria-hidden="true" tabindex="-1"></a>        qtyBefore<span class="op">,</span></span>
<span id="cb2-27"><a href="#cb2-27" aria-hidden="true" tabindex="-1"></a>        qtyAfter<span class="op">,</span></span>
<span id="cb2-28"><a href="#cb2-28" aria-hidden="true" tabindex="-1"></a>        price</span>
<span id="cb2-29"><a href="#cb2-29" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb2-30"><a href="#cb2-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <p><strong>Advanced Filtering Examples:</strong></p>
        <div class="sourceCode" id="cb3"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Find all updates for specific item from specific supplier</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> itemHistory <span class="op">=</span> repository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ITEM-001&quot;</span><span class="op">,</span>                    <span class="co">// Specific item</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;SUP-005&quot;</span><span class="op">,</span>                     <span class="co">// Specific supplier</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">null</span><span class="op">,</span>                          <span class="co">// Any reason</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">),</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">()</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="co">// Find all sales (quantity decreased) in date range</span></span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> sales <span class="op">=</span> repository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">null</span><span class="op">,</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">null</span><span class="op">,</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;SALE&quot;</span><span class="op">,</span></span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">),</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">12</span><span class="op">,</span> <span class="dv">31</span><span class="op">,</span> <span class="dv">23</span><span class="op">,</span> <span class="dv">59</span><span class="op">)</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a><span class="co">// Find all adjustments from any supplier</span></span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> adjustments <span class="op">=</span> repository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">null</span><span class="op">,</span></span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;SUP-999&quot;</span><span class="op">,</span>                     <span class="co">// Specific supplier</span></span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;ADJUSTMENT&quot;</span><span class="op">,</span></span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">().</span><span class="fu">minusMonths</span><span class="op">(</span><span class="dv">3</span><span class="op">),</span></span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">()</span></span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
        <p><strong>Use Cases:</strong> - Audit trail retrieval -
        Compliance reporting - Investigation of discrepancies - Supplier
        performance analysis - Inventory reconciliation</p>
        <hr />
        <h3
        id="streameventsforwacdate-supplierid">streamEventsForWAC(date,
        supplierId)</h3>
        <p><strong>Purpose:</strong> Stream supplier events for Weighted
        Average Cost calculation</p>
        <p><strong>Type:</strong> Native SQL returning Stream (memory
        efficient)</p>
        <p><strong>Returns:</strong> Stream&lt;Object[]&gt; with [id,
        item_id, name, quantity_after, price, total_value,
        event_date]</p>
        <p><strong>WAC Calculation Pattern:</strong></p>
        <p>Weighted Average Cost is calculated as:</p>
        <pre><code>WAC = Total Inventory Value / Total Units</code></pre>
        <p><strong>Usage:</strong></p>
        <div class="sourceCode" id="cb5"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate WAC for supplier items since date</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>LocalDateTime cutoffDate <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="bu">String</span> supplierId <span class="op">=</span> <span class="st">&quot;SUP-001&quot;</span><span class="op">;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="bu">BigDecimal</span> totalValue <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> totalUnits <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">(</span>Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> repository<span class="op">.</span><span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    cutoffDate<span class="op">,</span></span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    supplierId</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a><span class="op">))</span> <span class="op">{</span></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> event <span class="op">:</span> <span class="op">(</span><span class="bu">Iterable</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;)</span> events<span class="op">::</span>iterator<span class="op">)</span> <span class="op">{</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> event<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> event<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>        totalValue <span class="op">=</span> totalValue<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>        totalUnits <span class="op">+=</span> quantity<span class="op">;</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate WAC</span></span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="bu">BigDecimal</span> wac <span class="op">=</span> totalUnits <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>    totalValue<span class="op">.</span><span class="fu">divide</span><span class="op">(</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>totalUnits<span class="op">),</span></span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span><span class="op">,</span></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>        <span class="bu">RoundingMode</span><span class="op">.</span><span class="fu">HALF_UP</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">:</span></span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a><span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span></span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;Supplier </span><span class="sc">%s</span><span class="st"> WAC: $</span><span class="sc">%.2f</span><span class="st"> (Total: $</span><span class="sc">%.2f</span><span class="st">, Units: </span><span class="sc">%d</span><span class="st">)</span><span class="sc">%n</span><span class="st">&quot;</span><span class="op">,</span></span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>    supplierId<span class="op">,</span></span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>    wac<span class="op">,</span></span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>    totalValue<span class="op">,</span></span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>    totalUnits</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
        <p><strong>Per-Item WAC Calculation:</strong></p>
        <div class="sourceCode" id="cb6"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate WAC per item from supplier</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">BigDecimal</span><span class="op">&gt;</span> itemWacs <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">Integer</span><span class="op">&gt;</span> itemUnits <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> <span class="bu">BigDecimal</span><span class="op">&gt;</span> itemValues <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span> <span class="op">(</span>Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> repository<span class="op">.</span><span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>    LocalDateTime<span class="op">.</span><span class="fu">of</span><span class="op">(</span><span class="dv">2024</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">),</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">&quot;SUP-001&quot;</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="op">))</span> <span class="op">{</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>    events<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>event <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemName <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> event<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> price <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> event<span class="op">[</span><span class="dv">4</span><span class="op">];</span></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> event<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Accumulate by item</span></span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>        itemUnits<span class="op">.</span><span class="fu">put</span><span class="op">(</span>itemId<span class="op">,</span> itemUnits<span class="op">.</span><span class="fu">getOrDefault</span><span class="op">(</span>itemId<span class="op">,</span> <span class="dv">0</span><span class="op">)</span> <span class="op">+</span> quantity<span class="op">);</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>        itemValues<span class="op">.</span><span class="fu">put</span><span class="op">(</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>            itemId<span class="op">,</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>            itemValues<span class="op">.</span><span class="fu">getOrDefault</span><span class="op">(</span>itemId<span class="op">,</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">).</span><span class="fu">add</span><span class="op">(</span>value<span class="op">)</span></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">});</span></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Calculate per-item WAC</span></span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="bu">String</span> itemId <span class="op">:</span> itemUnits<span class="op">.</span><span class="fu">keySet</span><span class="op">())</span> <span class="op">{</span></span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> units <span class="op">=</span> itemUnits<span class="op">.</span><span class="fu">get</span><span class="op">(</span>itemId<span class="op">);</span></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> value <span class="op">=</span> itemValues<span class="op">.</span><span class="fu">get</span><span class="op">(</span>itemId<span class="op">);</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">BigDecimal</span> itemWac <span class="op">=</span> value<span class="op">.</span><span class="fu">divide</span><span class="op">(</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>units<span class="op">),</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>        <span class="dv">2</span><span class="op">,</span></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>        <span class="bu">RoundingMode</span><span class="op">.</span><span class="fu">HALF_UP</span></span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">);</span></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>    itemWacs<span class="op">.</span><span class="fu">put</span><span class="op">(</span>itemId<span class="op">,</span> itemWac<span class="op">);</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>itemWacs<span class="op">.</span><span class="fu">forEach</span><span class="op">((</span>itemId<span class="op">,</span> wac<span class="op">)</span> <span class="op">-&gt;</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a>    <span class="bu">System</span><span class="op">.</span><span class="fu">out</span><span class="op">.</span><span class="fu">printf</span><span class="op">(</span><span class="st">&quot;Item </span><span class="sc">%s</span><span class="st"> WAC: $</span><span class="sc">%.2f%n</span><span class="st">&quot;</span><span class="op">,</span> itemId<span class="op">,</span> wac<span class="op">)</span></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
        <p><strong>Use Cases:</strong> - Cost of goods accounting -
        Financial reporting (GAAP compliance) - Inventory valuation for
        balance sheet - Margin analysis - Supplier cost analysis</p>
        <hr />
        <h2 id="mixin-pattern-integration">Mixin Pattern
        Integration</h2>
        <p>StockDetailQueryRepository is implemented as a
        <strong>mixin</strong> by: - <code>StockHistoryRepository</code>
        (main data source)</p>
        <div class="sourceCode" id="cb7"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">interface</span> StockHistoryRepository <span class="kw">extends</span> JpaRepository<span class="op">&lt;</span>StockHistory<span class="op">,</span> <span class="bu">String</span><span class="op">&gt;,</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>                                               StockMetricsRepository<span class="op">,</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>                                               StockTrendAnalyticsRepository<span class="op">,</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                               StockDetailQueryRepository  <span class="co">// ‚Üê Mixin</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Additional query methods...</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <p>This allows StockHistoryRepository to expose detail query
        methods:</p>
        <div class="sourceCode" id="cb8"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Can call detail query methods through StockHistoryRepository</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> results <span class="op">=</span> stockHistoryRepository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    itemId<span class="op">,</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    supplierId<span class="op">,</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    reason<span class="op">,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    startDate<span class="op">,</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    endDate</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> stockHistoryRepository<span class="op">.</span><span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>    date<span class="op">,</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>    supplierId</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="op">);</span></span></code></pre></div>
        <hr />
        <h2 id="service-integration-pattern">Service Integration
        Pattern</h2>
        <div class="sourceCode" id="cb9"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="at">@Service</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="kw">public</span> <span class="kw">class</span> InventorySearchAndWACService <span class="op">{</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StockHistoryRepository stockHistoryRepository<span class="op">;</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Search stock history with advanced filtering</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>StockEventDTO<span class="op">&gt;</span> <span class="fu">searchStockEvents</span><span class="op">(</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        StockEventSearchCriteria criteria</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> results <span class="op">=</span> stockHistoryRepository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>            criteria<span class="op">.</span><span class="fu">getItemId</span><span class="op">(),</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>            criteria<span class="op">.</span><span class="fu">getSupplierId</span><span class="op">(),</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>            criteria<span class="op">.</span><span class="fu">getReason</span><span class="op">(),</span></span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>            criteria<span class="op">.</span><span class="fu">getStartDate</span><span class="op">(),</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>            criteria<span class="op">.</span><span class="fu">getEndDate</span><span class="op">()</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> results<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span>row <span class="op">-&gt;</span> StockEventDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">id</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> row<span class="op">[</span><span class="dv">0</span><span class="op">])</span></span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">itemId</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> row<span class="op">[</span><span class="dv">1</span><span class="op">])</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">itemName</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> row<span class="op">[</span><span class="dv">2</span><span class="op">])</span></span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">quantityBefore</span><span class="op">((</span><span class="dt">int</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">])</span></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">quantityAfter</span><span class="op">((</span><span class="dt">int</span><span class="op">)</span> row<span class="op">[</span><span class="dv">4</span><span class="op">])</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">reason</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> row<span class="op">[</span><span class="dv">5</span><span class="op">])</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">eventDate</span><span class="op">((</span>LocalDateTime<span class="op">)</span> row<span class="op">[</span><span class="dv">6</span><span class="op">])</span></span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">price</span><span class="op">((</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">7</span><span class="op">])</span></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">supplierName</span><span class="op">((</span><span class="bu">String</span><span class="op">)</span> row<span class="op">[</span><span class="dv">8</span><span class="op">])</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">quantityChange</span><span class="op">((</span><span class="dt">int</span><span class="op">)</span> row<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">])</span></span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">valueChange</span><span class="op">(</span></span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>                    <span class="op">((</span><span class="bu">BigDecimal</span><span class="op">)</span> row<span class="op">[</span><span class="dv">7</span><span class="op">]).</span><span class="fu">multiply</span><span class="op">(</span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>                        <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">((</span><span class="dt">int</span><span class="op">)</span> row<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">-</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> row<span class="op">[</span><span class="dv">3</span><span class="op">])</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>                    <span class="op">)</span></span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">())</span></span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Generate audit report for compliance</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> AuditReportDTO <span class="fu">generateAuditReport</span><span class="op">(</span></span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId<span class="op">,</span></span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>        LocalDate startDate<span class="op">,</span></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>        LocalDate endDate</span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> stockHistoryRepository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>            itemId<span class="op">,</span></span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>            <span class="kw">null</span><span class="op">,</span></span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>            <span class="kw">null</span><span class="op">,</span></span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>            startDate<span class="op">.</span><span class="fu">atStartOfDay</span><span class="op">(),</span></span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>            endDate<span class="op">.</span><span class="fu">atTime</span><span class="op">(</span><span class="dv">23</span><span class="op">,</span> <span class="dv">59</span><span class="op">,</span> <span class="dv">59</span><span class="op">)</span></span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> totalMovements <span class="op">=</span> events<span class="op">.</span><span class="fu">size</span><span class="op">();</span></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> restockCount <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> events<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>row <span class="op">-&gt;</span> <span class="st">&quot;RESTOCK&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>row<span class="op">[</span><span class="dv">5</span><span class="op">]))</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">count</span><span class="op">();</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> saleCount <span class="op">=</span> <span class="op">(</span><span class="dt">int</span><span class="op">)</span> events<span class="op">.</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">filter</span><span class="op">(</span>row <span class="op">-&gt;</span> <span class="st">&quot;SALE&quot;</span><span class="op">.</span><span class="fu">equals</span><span class="op">(</span>row<span class="op">[</span><span class="dv">5</span><span class="op">]))</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">count</span><span class="op">();</span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> AuditReportDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>itemId<span class="op">)</span></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reportPeriod</span><span class="op">(</span>startDate <span class="op">+</span> <span class="st">&quot; to &quot;</span> <span class="op">+</span> endDate<span class="op">)</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">totalMovements</span><span class="op">(</span>totalMovements<span class="op">)</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">restockCount</span><span class="op">(</span>restockCount<span class="op">)</span></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">saleCount</span><span class="op">(</span>saleCount<span class="op">)</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Calculate Weighted Average Cost <span class="co">(</span>WAC<span class="co">)</span> for supplier</span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> SupplierWACReportDTO <span class="fu">calculateSupplierWAC</span><span class="op">(</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> supplierId<span class="op">,</span></span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>        LocalDate fromDate</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> totalValue <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> totalUnits <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> eventCount <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">(</span>Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> stockHistoryRepository</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>                fromDate<span class="op">.</span><span class="fu">atStartOfDay</span><span class="op">(),</span></span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>                supplierId</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>            <span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> eventList <span class="op">=</span> events<span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>            <span class="cf">for</span> <span class="op">(</span><span class="bu">Object</span><span class="op">[]</span> event <span class="op">:</span> eventList<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> event<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>                <span class="bu">BigDecimal</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> event<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>                totalValue <span class="op">=</span> totalValue<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>                totalUnits <span class="op">+=</span> quantity<span class="op">;</span></span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>                eventCount<span class="op">++;</span></span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> wac <span class="op">=</span> totalUnits <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>            totalValue<span class="op">.</span><span class="fu">divide</span><span class="op">(</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>                <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>totalUnits<span class="op">),</span></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>                <span class="dv">2</span><span class="op">,</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>                <span class="bu">RoundingMode</span><span class="op">.</span><span class="fu">HALF_UP</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>            <span class="op">)</span> <span class="op">:</span></span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>            <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> SupplierWACReportDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">supplierId</span><span class="op">(</span>supplierId<span class="op">)</span></span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reportDate</span><span class="op">(</span>LocalDate<span class="op">.</span><span class="fu">now</span><span class="op">())</span></span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">fromDate</span><span class="op">(</span>fromDate<span class="op">)</span></span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">totalValue</span><span class="op">(</span>totalValue<span class="op">)</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">totalUnits</span><span class="op">(</span>totalUnits<span class="op">)</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">weightedAverageCost</span><span class="op">(</span>wac<span class="op">)</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">eventCount</span><span class="op">(</span>eventCount<span class="op">)</span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>    <span class="co">/**</span></span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>     <span class="co">*</span> Generate per<span class="co">-</span>item WAC for detailed analysis</span>
<span id="cb9-128"><a href="#cb9-128" aria-hidden="true" tabindex="-1"></a>     <span class="co">*/</span></span>
<span id="cb9-129"><a href="#cb9-129" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Transactional</span><span class="op">(</span>readOnly <span class="op">=</span> <span class="kw">true</span><span class="op">)</span></span>
<span id="cb9-130"><a href="#cb9-130" aria-hidden="true" tabindex="-1"></a>    <span class="kw">public</span> <span class="bu">List</span><span class="op">&lt;</span>ItemWACDTO<span class="op">&gt;</span> <span class="fu">calculatePerItemWAC</span><span class="op">(</span></span>
<span id="cb9-131"><a href="#cb9-131" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> supplierId<span class="op">,</span></span>
<span id="cb9-132"><a href="#cb9-132" aria-hidden="true" tabindex="-1"></a>        LocalDate fromDate</span>
<span id="cb9-133"><a href="#cb9-133" aria-hidden="true" tabindex="-1"></a>    <span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-134"><a href="#cb9-134" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Map</span><span class="op">&lt;</span><span class="bu">String</span><span class="op">,</span> ItemWACData<span class="op">&gt;</span> itemWacs <span class="op">=</span> <span class="kw">new</span> <span class="bu">HashMap</span><span class="op">&lt;&gt;();</span></span>
<span id="cb9-135"><a href="#cb9-135" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-136"><a href="#cb9-136" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">(</span>Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> stockHistoryRepository</span>
<span id="cb9-137"><a href="#cb9-137" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb9-138"><a href="#cb9-138" aria-hidden="true" tabindex="-1"></a>                fromDate<span class="op">.</span><span class="fu">atStartOfDay</span><span class="op">(),</span></span>
<span id="cb9-139"><a href="#cb9-139" aria-hidden="true" tabindex="-1"></a>                supplierId</span>
<span id="cb9-140"><a href="#cb9-140" aria-hidden="true" tabindex="-1"></a>            <span class="op">))</span> <span class="op">{</span></span>
<span id="cb9-141"><a href="#cb9-141" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-142"><a href="#cb9-142" aria-hidden="true" tabindex="-1"></a>            events<span class="op">.</span><span class="fu">forEach</span><span class="op">(</span>event <span class="op">-&gt;</span> <span class="op">{</span></span>
<span id="cb9-143"><a href="#cb9-143" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> itemId <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb9-144"><a href="#cb9-144" aria-hidden="true" tabindex="-1"></a>                <span class="bu">String</span> itemName <span class="op">=</span> <span class="op">(</span><span class="bu">String</span><span class="op">)</span> event<span class="op">[</span><span class="dv">2</span><span class="op">];</span></span>
<span id="cb9-145"><a href="#cb9-145" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Integer</span> quantity <span class="op">=</span> <span class="op">(</span><span class="bu">Integer</span><span class="op">)</span> event<span class="op">[</span><span class="dv">3</span><span class="op">];</span></span>
<span id="cb9-146"><a href="#cb9-146" aria-hidden="true" tabindex="-1"></a>                <span class="bu">BigDecimal</span> value <span class="op">=</span> <span class="op">(</span><span class="bu">BigDecimal</span><span class="op">)</span> event<span class="op">[</span><span class="dv">5</span><span class="op">];</span></span>
<span id="cb9-147"><a href="#cb9-147" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-148"><a href="#cb9-148" aria-hidden="true" tabindex="-1"></a>                ItemWACData data <span class="op">=</span> itemWacs<span class="op">.</span><span class="fu">computeIfAbsent</span><span class="op">(</span></span>
<span id="cb9-149"><a href="#cb9-149" aria-hidden="true" tabindex="-1"></a>                    itemId<span class="op">,</span></span>
<span id="cb9-150"><a href="#cb9-150" aria-hidden="true" tabindex="-1"></a>                    k <span class="op">-&gt;</span> <span class="kw">new</span> <span class="fu">ItemWACData</span><span class="op">(</span>itemName<span class="op">)</span></span>
<span id="cb9-151"><a href="#cb9-151" aria-hidden="true" tabindex="-1"></a>                <span class="op">);</span></span>
<span id="cb9-152"><a href="#cb9-152" aria-hidden="true" tabindex="-1"></a>                </span>
<span id="cb9-153"><a href="#cb9-153" aria-hidden="true" tabindex="-1"></a>                data<span class="op">.</span><span class="fu">addValue</span><span class="op">(</span>quantity<span class="op">,</span> value<span class="op">);</span></span>
<span id="cb9-154"><a href="#cb9-154" aria-hidden="true" tabindex="-1"></a>            <span class="op">});</span></span>
<span id="cb9-155"><a href="#cb9-155" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-156"><a href="#cb9-156" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-157"><a href="#cb9-157" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> itemWacs<span class="op">.</span><span class="fu">values</span><span class="op">().</span><span class="fu">stream</span><span class="op">()</span></span>
<span id="cb9-158"><a href="#cb9-158" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">map</span><span class="op">(</span>ItemWACData<span class="op">::</span>toDTO<span class="op">)</span></span>
<span id="cb9-159"><a href="#cb9-159" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb9-160"><a href="#cb9-160" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-161"><a href="#cb9-161" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-162"><a href="#cb9-162" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> <span class="dt">static</span> <span class="kw">class</span> ItemWACData <span class="op">{</span></span>
<span id="cb9-163"><a href="#cb9-163" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemId<span class="op">;</span></span>
<span id="cb9-164"><a href="#cb9-164" aria-hidden="true" tabindex="-1"></a>        <span class="bu">String</span> itemName<span class="op">;</span></span>
<span id="cb9-165"><a href="#cb9-165" aria-hidden="true" tabindex="-1"></a>        <span class="bu">BigDecimal</span> totalValue <span class="op">=</span> <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb9-166"><a href="#cb9-166" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> totalUnits <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb9-167"><a href="#cb9-167" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-168"><a href="#cb9-168" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ItemWACData</span><span class="op">(</span><span class="bu">String</span> itemName<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-169"><a href="#cb9-169" aria-hidden="true" tabindex="-1"></a>            <span class="kw">this</span><span class="op">.</span><span class="fu">itemName</span> <span class="op">=</span> itemName<span class="op">;</span></span>
<span id="cb9-170"><a href="#cb9-170" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-171"><a href="#cb9-171" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-172"><a href="#cb9-172" aria-hidden="true" tabindex="-1"></a>        <span class="dt">void</span> <span class="fu">addValue</span><span class="op">(</span><span class="dt">int</span> units<span class="op">,</span> <span class="bu">BigDecimal</span> value<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-173"><a href="#cb9-173" aria-hidden="true" tabindex="-1"></a>            totalUnits <span class="op">+=</span> units<span class="op">;</span></span>
<span id="cb9-174"><a href="#cb9-174" aria-hidden="true" tabindex="-1"></a>            totalValue <span class="op">=</span> totalValue<span class="op">.</span><span class="fu">add</span><span class="op">(</span>value<span class="op">);</span></span>
<span id="cb9-175"><a href="#cb9-175" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-176"><a href="#cb9-176" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb9-177"><a href="#cb9-177" aria-hidden="true" tabindex="-1"></a>        ItemWACDTO <span class="fu">toDTO</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb9-178"><a href="#cb9-178" aria-hidden="true" tabindex="-1"></a>            <span class="bu">BigDecimal</span> wac <span class="op">=</span> totalUnits <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span></span>
<span id="cb9-179"><a href="#cb9-179" aria-hidden="true" tabindex="-1"></a>                totalValue<span class="op">.</span><span class="fu">divide</span><span class="op">(</span></span>
<span id="cb9-180"><a href="#cb9-180" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">valueOf</span><span class="op">(</span>totalUnits<span class="op">),</span></span>
<span id="cb9-181"><a href="#cb9-181" aria-hidden="true" tabindex="-1"></a>                    <span class="dv">2</span><span class="op">,</span></span>
<span id="cb9-182"><a href="#cb9-182" aria-hidden="true" tabindex="-1"></a>                    <span class="bu">RoundingMode</span><span class="op">.</span><span class="fu">HALF_UP</span></span>
<span id="cb9-183"><a href="#cb9-183" aria-hidden="true" tabindex="-1"></a>                <span class="op">)</span> <span class="op">:</span></span>
<span id="cb9-184"><a href="#cb9-184" aria-hidden="true" tabindex="-1"></a>                <span class="bu">BigDecimal</span><span class="op">.</span><span class="fu">ZERO</span><span class="op">;</span></span>
<span id="cb9-185"><a href="#cb9-185" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb9-186"><a href="#cb9-186" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> ItemWACDTO<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb9-187"><a href="#cb9-187" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>itemId<span class="op">)</span></span>
<span id="cb9-188"><a href="#cb9-188" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">itemName</span><span class="op">(</span>itemName<span class="op">)</span></span>
<span id="cb9-189"><a href="#cb9-189" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">totalValue</span><span class="op">(</span>totalValue<span class="op">)</span></span>
<span id="cb9-190"><a href="#cb9-190" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">totalUnits</span><span class="op">(</span>totalUnits<span class="op">)</span></span>
<span id="cb9-191"><a href="#cb9-191" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">weightedAverageCost</span><span class="op">(</span>wac<span class="op">)</span></span>
<span id="cb9-192"><a href="#cb9-192" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">();</span></span>
<span id="cb9-193"><a href="#cb9-193" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb9-194"><a href="#cb9-194" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb9-195"><a href="#cb9-195" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <hr />
        <h2 id="testing">Testing</h2>
        <div class="sourceCode" id="cb10"><pre
        class="sourceCode java"><code class="sourceCode java"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="at">@DataJpaTest</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> StockDetailQueryRepositoryTest <span class="op">{</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> StockHistoryRepository repository<span class="op">;</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> InventoryItemRepository itemRepository<span class="op">;</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Autowired</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">private</span> SupplierRepository supplierRepository<span class="op">;</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">testSearchStockUpdates</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Setup</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>        Supplier supplier <span class="op">=</span> supplierRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span></span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>            Supplier<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;SUP-001&quot;</span><span class="op">)</span></span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">name</span><span class="op">(</span><span class="st">&quot;Widget Corp&quot;</span><span class="op">)</span></span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        InventoryItem item <span class="op">=</span> itemRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span></span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>            InventoryItem<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;ITEM-001&quot;</span><span class="op">)</span></span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">name</span><span class="op">(</span><span class="st">&quot;Widget&quot;</span><span class="op">)</span></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">price</span><span class="op">(</span><span class="kw">new</span> <span class="bu">BigDecimal</span><span class="op">(</span><span class="st">&quot;10.00&quot;</span><span class="op">))</span></span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">quantity</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">supplierId</span><span class="op">(</span>supplier<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">minimumQuantity</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">createdAt</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">())</span></span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a>        LocalDateTime date <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>StockHistory<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;SH-001&quot;</span><span class="op">)</span></span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>item<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityBefore</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityAfter</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reason</span><span class="op">(</span><span class="st">&quot;RESTOCK&quot;</span><span class="op">)</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">eventDate</span><span class="op">(</span>date<span class="op">)</span></span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">());</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test search</span></span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>        <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> results <span class="op">=</span> repository<span class="op">.</span><span class="fu">searchStockUpdates</span><span class="op">(</span></span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;ITEM-001&quot;</span><span class="op">,</span></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;SUP-001&quot;</span><span class="op">,</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>            <span class="st">&quot;RESTOCK&quot;</span><span class="op">,</span></span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a>            date<span class="op">.</span><span class="fu">minusHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a>            date<span class="op">.</span><span class="fu">plusHours</span><span class="op">(</span><span class="dv">1</span><span class="op">)</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> results<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>        <span class="fu">assertEquals</span><span class="op">(</span><span class="st">&quot;Widget&quot;</span><span class="op">,</span> results<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">2</span><span class="op">]);</span></span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">@Test</span></span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a>    <span class="dt">void</span> <span class="fu">testStreamEventsForWAC</span><span class="op">()</span> <span class="op">{</span></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Setup supplier and item</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>        Supplier supplier <span class="op">=</span> supplierRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span></span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a>            Supplier<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;SUP-001&quot;</span><span class="op">)</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">name</span><span class="op">(</span><span class="st">&quot;Supplier 1&quot;</span><span class="op">)</span></span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a>        InventoryItem item <span class="op">=</span> itemRepository<span class="op">.</span><span class="fu">save</span><span class="op">(</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a>            InventoryItem<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;ITEM-001&quot;</span><span class="op">)</span></span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">name</span><span class="op">(</span><span class="st">&quot;Product&quot;</span><span class="op">)</span></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">price</span><span class="op">(</span><span class="kw">new</span> <span class="bu">BigDecimal</span><span class="op">(</span><span class="st">&quot;50.00&quot;</span><span class="op">))</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">quantity</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">supplierId</span><span class="op">(</span>supplier<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">minimumQuantity</span><span class="op">(</span><span class="dv">10</span><span class="op">)</span></span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">createdAt</span><span class="op">(</span>LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">())</span></span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>                <span class="op">.</span><span class="fu">build</span><span class="op">()</span></span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>        <span class="op">);</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a>        LocalDateTime date <span class="op">=</span> LocalDateTime<span class="op">.</span><span class="fu">now</span><span class="op">();</span></span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a>        repository<span class="op">.</span><span class="fu">save</span><span class="op">(</span>StockHistory<span class="op">.</span><span class="fu">builder</span><span class="op">()</span></span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">id</span><span class="op">(</span><span class="st">&quot;SH-001&quot;</span><span class="op">)</span></span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">itemId</span><span class="op">(</span>item<span class="op">.</span><span class="fu">getId</span><span class="op">())</span></span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityBefore</span><span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">quantityAfter</span><span class="op">(</span><span class="dv">100</span><span class="op">)</span></span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">reason</span><span class="op">(</span><span class="st">&quot;INITIAL&quot;</span><span class="op">)</span></span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">eventDate</span><span class="op">(</span>date<span class="op">)</span></span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">createdBy</span><span class="op">(</span><span class="st">&quot;test&quot;</span><span class="op">)</span></span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span><span class="fu">build</span><span class="op">());</span></span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb10-94"><a href="#cb10-94" aria-hidden="true" tabindex="-1"></a>        <span class="co">// Test WAC stream</span></span>
<span id="cb10-95"><a href="#cb10-95" aria-hidden="true" tabindex="-1"></a>        <span class="cf">try</span> <span class="op">(</span>Stream<span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> events <span class="op">=</span> repository<span class="op">.</span><span class="fu">streamEventsForWAC</span><span class="op">(</span></span>
<span id="cb10-96"><a href="#cb10-96" aria-hidden="true" tabindex="-1"></a>            date<span class="op">.</span><span class="fu">minusHours</span><span class="op">(</span><span class="dv">1</span><span class="op">),</span></span>
<span id="cb10-97"><a href="#cb10-97" aria-hidden="true" tabindex="-1"></a>            supplier<span class="op">.</span><span class="fu">getId</span><span class="op">()</span></span>
<span id="cb10-98"><a href="#cb10-98" aria-hidden="true" tabindex="-1"></a>        <span class="op">))</span> <span class="op">{</span></span>
<span id="cb10-99"><a href="#cb10-99" aria-hidden="true" tabindex="-1"></a>            <span class="bu">List</span><span class="op">&lt;</span><span class="bu">Object</span><span class="op">[]&gt;</span> results <span class="op">=</span> events<span class="op">.</span><span class="fu">collect</span><span class="op">(</span>Collectors<span class="op">.</span><span class="fu">toList</span><span class="op">());</span></span>
<span id="cb10-100"><a href="#cb10-100" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb10-101"><a href="#cb10-101" aria-hidden="true" tabindex="-1"></a>            <span class="fu">assertEquals</span><span class="op">(</span><span class="dv">1</span><span class="op">,</span> results<span class="op">.</span><span class="fu">size</span><span class="op">());</span></span>
<span id="cb10-102"><a href="#cb10-102" aria-hidden="true" tabindex="-1"></a>            <span class="fu">assertEquals</span><span class="op">(</span><span class="dv">100</span><span class="op">,</span> results<span class="op">.</span><span class="fu">get</span><span class="op">(</span><span class="dv">0</span><span class="op">)[</span><span class="dv">3</span><span class="op">]);</span> <span class="co">// quantity</span></span>
<span id="cb10-103"><a href="#cb10-103" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb10-104"><a href="#cb10-104" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-105"><a href="#cb10-105" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
        <hr />
        <h2 id="performance-notes">Performance Notes</h2>
        <ul>
        <li><strong>Stream API:</strong> Memory efficient for large
        datasets</li>
        <li><strong>Multi-table JOINs:</strong> Adds item price and
        supplier info efficiently</li>
        <li><strong>Optional Filtering:</strong> NULL parameters
        excluded from WHERE clause</li>
        <li><strong>WAC Calculation:</strong> Stream processing prevents
        loading all data into memory</li>
        <li><strong>Suitable for:</strong> Reports, audits, compliance,
        financial statements</li>
        </ul>
        <hr />
        <h2 id="related-documentation">Related Documentation</h2>
        <ul>
        <li><a href="./stock-history-repository.html">Stock History
        Repository</a> (implements mixin)</li>
        <li><a href="./stock-metrics-repository.html">Stock Metrics
        Repository</a></li>
        <li><a href="./stock-trend-analytics-repository.html">Stock
        Trend Analytics Repository</a></li>
        <li><a href="./index.html">Repository Layer Index</a></li>
        </ul>
        <hr />
        <p><a href="./index.html">‚¨ÖÔ∏è Back to Repository Index</a></p>
      </article>
    </section>
  </main>

  <footer class="footer">
    Smart Supply Pro ¬∑ Generated by Docs Pipeline
  </footer>

  <!-- Mermaid for diagrams in ```mermaid``` blocks -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <script>mermaid.initialize({ startOnLoad: true });</script>
</body>
</html>
