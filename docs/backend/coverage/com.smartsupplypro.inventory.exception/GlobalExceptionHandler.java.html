<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>GlobalExceptionHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.smartsupplypro.inventory.exception</a> &gt; <span class="el_source">GlobalExceptionHandler.java</span></div><h1>GlobalExceptionHandler.java</h1><pre class="source lang-java linenums">package com.smartsupplypro.inventory.exception;

import java.util.HashMap;
import java.util.Map;
import java.util.NoSuchElementException;

import org.springframework.core.Ordered;
import org.springframework.core.annotation.Order;
import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;
import org.springframework.http.ResponseEntity;
import org.springframework.http.converter.HttpMessageNotReadableException;
import org.springframework.orm.ObjectOptimisticLockingFailureException;
import org.springframework.security.access.AccessDeniedException;
import org.springframework.security.core.AuthenticationException;
import org.springframework.web.bind.MethodArgumentNotValidException;
import org.springframework.web.bind.MissingServletRequestParameterException;
import org.springframework.web.bind.annotation.ExceptionHandler;
import org.springframework.web.bind.annotation.ResponseStatus;
import org.springframework.web.bind.annotation.RestControllerAdvice;
import org.springframework.web.method.annotation.MethodArgumentTypeMismatchException;
import org.springframework.web.server.ResponseStatusException;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.validation.ConstraintViolationException;

/**
 * Enterprise global exception handler for REST API standardization.
 *
 * &lt;p&gt;Provides unified error response structure, HTTP status code mapping, and consistent
 * client experience across all API endpoints with comprehensive exception translation.
 *
 * &lt;p&gt;&lt;strong&gt;Response Format&lt;/strong&gt;: {@code {&quot;error&quot;: &quot;status_token&quot;, &quot;message&quot;: &quot;description&quot;}}
 * 
 * &lt;p&gt;&lt;strong&gt;Status Mapping Strategy&lt;/strong&gt;:
 * &lt;ul&gt;
 *   &lt;li&gt;&lt;strong&gt;400&lt;/strong&gt; – Client validation errors, malformed requests, parameter issues&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;401&lt;/strong&gt; – Authentication failures, missing credentials&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;403&lt;/strong&gt; – Authorization failures, insufficient permissions&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;404&lt;/strong&gt; – Resource not found, invalid endpoints&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;409&lt;/strong&gt; – Business conflicts, constraint violations, concurrent updates&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;500&lt;/strong&gt; – Unhandled server errors, system failures&lt;/li&gt;
 * &lt;/ul&gt;
 * 
 * &lt;p&gt;Key integrations: REST controllers, Service validation, Security framework, Data layer.
 * 
 * @author Smart Supply Pro Development Team
 * @version 1.0.0
 * @since 1.0.0
 */
@Order(Ordered.HIGHEST_PRECEDENCE)
@RestControllerAdvice
<span class="fc" id="L54">public class GlobalExceptionHandler {</span>

    /* =======================================================================
     * Helpers
     * ======================================================================= */

    /**
     * Constructs standardized JSON error response with HTTP status mapping.
     *
     * &lt;p&gt;Ensures consistent API contract with normalized error tokens and
     * human-readable messages for reliable client error handling.
     * 
     * @param status HTTP status code for response
     * @param message descriptive error message for client
     * @return standardized JSON error response entity
     */
    private ResponseEntity&lt;Map&lt;String, String&gt;&gt; body(HttpStatus status, String message) {
<span class="fc" id="L71">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L72">        map.put(&quot;error&quot;, errorCode(status));</span>
<span class="fc" id="L73">        map.put(&quot;message&quot;, nonEmpty(message, status.getReasonPhrase()));</span>
<span class="fc" id="L74">        map.put(&quot;timestamp&quot;, java.time.Instant.now().toString());</span>
<span class="fc" id="L75">        map.put(&quot;correlationId&quot;, generateCorrelationId());</span>
<span class="fc" id="L76">        return ResponseEntity.status(status)</span>
<span class="fc" id="L77">                .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L78">                .body(map);</span>
    }

    /**
     * Generates unique correlation ID for request tracking and debugging.
     * 
     * @return formatted correlation ID
     */
    private String generateCorrelationId() {
<span class="fc" id="L87">        return &quot;SSP-&quot; + System.currentTimeMillis() + &quot;-&quot; + </span>
<span class="fc" id="L88">               java.util.concurrent.ThreadLocalRandom.current().nextInt(1000, 9999);</span>
    }

    /**
     * Sanitizes error messages to prevent sensitive information disclosure.
     * 
     * @param message original error message
     * @return sanitized message safe for client response
     */
    private String sanitizeMessage(String message) {
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if (message == null) return &quot;Unknown error&quot;;</span>
        
        // Remove sensitive patterns
<span class="fc" id="L101">        return message</span>
<span class="fc" id="L102">            .replaceAll(&quot;\\b[A-Za-z]:\\\\[\\w\\\\.-]+&quot;, &quot;[PATH]&quot;)</span>
<span class="fc" id="L103">            .replaceAll(&quot;\\bcom\\.smartsupplypro\\.[\\w.]+&quot;, &quot;[INTERNAL]&quot;)</span>
<span class="fc" id="L104">            .replaceAll(&quot;\\bSQL.*&quot;, &quot;Database operation failed&quot;)</span>
<span class="fc" id="L105">            .replaceAll(&quot;\\bPassword.*&quot;, &quot;Authentication failed&quot;)</span>
<span class="fc" id="L106">            .replaceAll(&quot;\\bToken.*&quot;, &quot;Authentication failed&quot;)</span>
<span class="fc" id="L107">            .trim();</span>
    }

    /** Normalize an HTTP status into a lowercase token (e.g., BAD_REQUEST → &quot;bad_request&quot;). */
    private static String errorCode(HttpStatus status) {
<span class="fc" id="L112">        return status.name().toLowerCase(); // &quot;bad_request&quot;, &quot;not_found&quot;, &quot;conflict&quot;, etc.</span>
    }

    private static String nonEmpty(String s, String fallback) {
<span class="pc bpc" id="L116" title="2 of 4 branches missed.">        return (s == null || s.isBlank()) ? fallback : s;</span>
    }

    /* =======================================================================
     * 400 Bad Request family
     * ======================================================================= */

    /**
     * Handles custom application validation failures with business context.
     * 
     * @param ex application-specific validation exception
     * @return 400 Bad Request with validation details
     */
    @ExceptionHandler(InvalidRequestException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleInvalid(InvalidRequestException ex) {
<span class="pc bpc" id="L131" title="1 of 2 branches missed.">        String message = ex.hasFieldErrors() ? </span>
<span class="nc" id="L132">            &quot;Validation failed: &quot; + ex.getFieldErrors().size() + &quot; field error(s)&quot; :</span>
<span class="fc" id="L133">            nonEmpty(ex.getMessage(), &quot;Invalid request&quot;);</span>
        
        // Use sanitized message for response
<span class="fc" id="L136">        return body(HttpStatus.BAD_REQUEST, sanitizeMessage(message));</span>
    }

    /**
     * Bean validation failures on request bodies with enhanced field error extraction.
     * 
     * @param ex Spring validation exception with field-level details
     * @return 400 Bad Request with specific field validation errors
     */
    @ExceptionHandler(MethodArgumentNotValidException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleMethodArgumentNotValid(MethodArgumentNotValidException ex) {
<span class="fc" id="L147">        String first = ex.getBindingResult().getFieldErrors().stream()</span>
<span class="fc" id="L148">                .findFirst()</span>
<span class="fc" id="L149">                .map(fe -&gt; fe.getField() + &quot; &quot; + fe.getDefaultMessage())</span>
<span class="fc" id="L150">                .orElse(&quot;Validation failed&quot;);</span>
<span class="fc" id="L151">        return body(HttpStatus.BAD_REQUEST, sanitizeMessage(first));</span>
    }

    /**
     * Constraint validation failures with enhanced error path extraction.
     * 
     * @param ex constraint violation exception with validation details
     * @return 400 Bad Request with constraint violation details
     */
    @ExceptionHandler(ConstraintViolationException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleConstraintViolation(ConstraintViolationException ex) {
<span class="nc" id="L162">        String first = ex.getConstraintViolations().stream()</span>
<span class="nc" id="L163">                .findFirst()</span>
<span class="nc" id="L164">                .map(v -&gt; v.getPropertyPath() + &quot; &quot; + v.getMessage())</span>
<span class="nc" id="L165">                .orElse(&quot;Constraint violation&quot;);</span>
<span class="nc" id="L166">        return body(HttpStatus.BAD_REQUEST, sanitizeMessage(first));</span>
    }

    /**
     * JSON parsing failures with enhanced error context.
     * 
     * @param ex HTTP message parsing exception
     * @return 400 Bad Request with parsing error details
     */
    @ExceptionHandler(HttpMessageNotReadableException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleNotReadable(HttpMessageNotReadableException ex) {
<span class="nc" id="L177">        return body(HttpStatus.BAD_REQUEST, sanitizeMessage(&quot;Request body is invalid or unreadable&quot;));</span>
    }

    /**
     * Missing required request parameters with parameter identification.
     * 
     * @param ex missing parameter exception with parameter details
     * @return 400 Bad Request with missing parameter information
     */
    @ExceptionHandler(MissingServletRequestParameterException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleMissingParam(MissingServletRequestParameterException ex) {
<span class="fc" id="L188">        return body(HttpStatus.BAD_REQUEST, &quot;Missing required parameter: &quot; + ex.getParameterName());</span>
    }

    /**
     * Parameter type conversion failures with field identification.
     * 
     * @param ex type mismatch exception with parameter details
     * @return 400 Bad Request with type conversion error
     */
    @ExceptionHandler(MethodArgumentTypeMismatchException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleTypeMismatch(MethodArgumentTypeMismatchException ex) {
<span class="fc" id="L199">        return body(HttpStatus.BAD_REQUEST, &quot;Invalid value for: &quot; + ex.getName());</span>
    }

    /* =======================================================================
     * 401 / 403 Security
     * ======================================================================= */

    /**
     * Authentication failures with secure error response for credential issues.
     * 
     * @param ex Spring Security authentication exception
     * @return 401 Unauthorized with generic authentication message
     */
    @ExceptionHandler(AuthenticationException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleAuthentication(AuthenticationException ex) {
<span class="nc" id="L214">        return body(HttpStatus.UNAUTHORIZED, &quot;Authentication required&quot;);</span>
    }

    /**
     * Authorization failures with role-based access control enforcement.
     * 
     * @param ex Spring Security access denied exception  
     * @return 403 Forbidden with generic access denied message
     */
    @ExceptionHandler(AccessDeniedException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleAccessDenied(AccessDeniedException ex) {
<span class="fc" id="L225">        return body(HttpStatus.FORBIDDEN, &quot;Access denied&quot;);</span>
    }

    /* =======================================================================
     * 404 Not Found
     * ======================================================================= */

    /**
     * Resource existence validation failures with sanitized error messages.
     * 
     * @param ex illegal argument exception indicating resource not found
     * @return 404 Not Found with sanitized resource identification
     */
    @ExceptionHandler(IllegalArgumentException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleIllegalArgument(IllegalArgumentException ex) {
<span class="nc" id="L240">        return body(HttpStatus.NOT_FOUND, sanitizeMessage(nonEmpty(ex.getMessage(), &quot;Resource not found&quot;)));</span>
    }

    /**
     * Repository lookup failures with enhanced error context.
     * 
     * @param ex no such element exception from repository operations
     * @return 404 Not Found with sanitized error details
     */
    @ExceptionHandler(NoSuchElementException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleNoSuchElement(NoSuchElementException ex) {
<span class="fc" id="L251">        return body(HttpStatus.NOT_FOUND, sanitizeMessage(nonEmpty(ex.getMessage(), &quot;Resource not found&quot;)));</span>
    }

    /**
     * Static resource access failures for missing web assets.
     * 
     * @return 404 Not Found with no response body for resource efficiency
     */
    @ExceptionHandler(org.springframework.web.servlet.resource.NoResourceFoundException.class)
    @ResponseStatus(HttpStatus.NOT_FOUND)
<span class="nc" id="L261">    public void notFound() { /* no body */ }</span>

    /* =======================================================================
     * 409 Conflict
     * ======================================================================= */

    /**
     * Handles enterprise duplicate resource violations with conflict resolution.
     * 
     * @param ex business rule uniqueness constraint exception
     * @return 409 Conflict with resource conflict details
     */
    @ExceptionHandler(DuplicateResourceException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleDuplicate(DuplicateResourceException ex) {
<span class="pc bpc" id="L275" title="1 of 2 branches missed.">        String message = ex.hasDetailedContext() ? </span>
<span class="nc" id="L276">            ex.getClientMessage() : </span>
<span class="fc" id="L277">            nonEmpty(ex.getMessage(), &quot;Duplicate resource&quot;);</span>
        
<span class="fc" id="L279">        return body(HttpStatus.CONFLICT, sanitizeMessage(message));</span>
    }

    /**
     * Database constraint violations with enterprise conflict resolution.
     * 
     * @param ex Spring Data integrity violation exception
     * @return 409 Conflict with sanitized database constraint details
     */
    @ExceptionHandler(DataIntegrityViolationException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleDataIntegrity(DataIntegrityViolationException ex) {
<span class="nc" id="L290">        return body(HttpStatus.CONFLICT, sanitizeMessage(&quot;Data conflict&quot;));</span>
    }

    /**
     * Business state violations with operational context preservation.
     * 
     * &lt;p&gt;Handles enterprise business rule conflicts such as deleting suppliers with 
     * active inventory or state transition violations requiring specific conditions.&lt;/p&gt;
     * 
     * @param ex illegal state exception indicating business rule violation
     * @return 409 Conflict with business context details
     */
    @ExceptionHandler(IllegalStateException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleIllegalState(IllegalStateException ex) {
<span class="fc" id="L304">        return body(HttpStatus.CONFLICT, sanitizeMessage(nonEmpty(ex.getMessage(), &quot;Business rule conflict&quot;)));</span>
    }

    /**
     * Concurrent modification conflicts with optimistic locking support.
     * 
     * @param ex JPA optimistic locking failure exception
     * @return 409 Conflict with concurrent update notification
     */
    @ExceptionHandler(ObjectOptimisticLockingFailureException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleOptimistic(ObjectOptimisticLockingFailureException ex) {
<span class="nc" id="L315">        return body(HttpStatus.CONFLICT, &quot;Concurrent update detected - please retry&quot;);</span>
    }

    /* =======================================================================
     * Pass-through (ResponseStatusException)
     * ======================================================================= */

    /**
     * ResponseStatusException pass-through with status preservation and enhanced tracking.
     * 
     * &lt;p&gt;Maintains original HTTP status codes while adding enterprise tracking capabilities
     * for explicit controller-level exceptions and custom status scenarios.&lt;/p&gt;
     * 
     * @param ex response status exception with embedded HTTP status
     * @param request HTTP servlet request for context extraction
     * @return original status code with enhanced error response structure
     */
    @ExceptionHandler(ResponseStatusException.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleResponseStatus(ResponseStatusException ex,
                                                                     HttpServletRequest request) {
<span class="fc" id="L335">        Map&lt;String, String&gt; map = new HashMap&lt;&gt;();</span>
<span class="fc" id="L336">        map.put(&quot;error&quot;, ex.getStatusCode().toString().toLowerCase());</span>
<span class="fc" id="L337">        map.put(&quot;message&quot;, sanitizeMessage(nonEmpty(ex.getReason(), &quot;Request failed&quot;)));</span>
<span class="fc" id="L338">        map.put(&quot;timestamp&quot;, java.time.Instant.now().toString());</span>
<span class="fc" id="L339">        map.put(&quot;correlationId&quot;, generateCorrelationId());</span>
<span class="fc" id="L340">        return ResponseEntity.status(ex.getStatusCode())</span>
<span class="fc" id="L341">                .contentType(MediaType.APPLICATION_JSON)</span>
<span class="fc" id="L342">                .body(map);</span>
    }

    /* =======================================================================
     * 500 Internal Server Error (safety net)
     * ======================================================================= */

    /**
     * Enterprise safety net for unhandled exceptions with comprehensive error tracking.
     * 
     * &lt;p&gt;Provides stable API contract while preventing sensitive information disclosure.
     * Includes correlation tracking for debugging and monitoring integration.&lt;/p&gt;
     * 
     * @param ex any unhandled exception reaching the global handler
     * @return 500 Internal Server Error with sanitized generic message
     */
    @ExceptionHandler(Exception.class)
    public ResponseEntity&lt;Map&lt;String, String&gt;&gt; handleAny(Exception ex) {
        // Note: Consider adding ERROR-level logging with correlation ID for production monitoring
<span class="nc" id="L361">        return body(HttpStatus.INTERNAL_SERVER_ERROR, &quot;Unexpected server error&quot;);</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>