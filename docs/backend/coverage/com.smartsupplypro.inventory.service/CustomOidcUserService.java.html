<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomOidcUserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.smartsupplypro.inventory.service</a> &gt; <span class="el_source">CustomOidcUserService.java</span></div><h1>CustomOidcUserService.java</h1><pre class="source lang-java linenums">package com.smartsupplypro.inventory.service;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.Set;
import java.util.stream.Collectors;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;
import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.oidc.user.DefaultOidcUser;
import org.springframework.security.oauth2.core.oidc.user.OidcUser;
import org.springframework.stereotype.Service;

import com.smartsupplypro.inventory.model.AppUser;
import com.smartsupplypro.inventory.model.Role;
import com.smartsupplypro.inventory.repository.AppUserRepository;

/**
 * Custom OIDC user service that runs for providers sending the &quot;openid&quot; scope (e.g., Google).
 *
 * &lt;p&gt;&lt;b&gt;Why we need this:&lt;/b&gt; For OIDC logins Spring Security invokes an {@link OAuth2UserService}
 * parametrized as {@code OAuth2UserService&lt;OidcUserRequest, OidcUser&gt;} rather than the plain
 * {@code OAuth2UserService&lt;OAuth2UserRequest, OAuth2User&gt;}. If we only customize the latter,
 * our role mapping (ROLE_USER / ROLE_ADMIN) never runs, resulting in requests that carry only
 * authorities like {@code OIDC_USER} and scopes, but &lt;em&gt;not&lt;/em&gt; {@code ROLE_ADMIN}.&lt;/p&gt;
 *
 * &lt;p&gt;This implementation delegates to the default {@link OidcUserService} to load the upstream
 * OIDC user, then:
 * &lt;ol&gt;
 *   &lt;li&gt;Reads the user's email from OIDC claims.&lt;/li&gt;
 *   &lt;li&gt;Finds/creates a local {@link AppUser} record and assigns {@code Role.ADMIN} when the
 *       email is present in the environment variable {@code APP_ADMIN_EMAILS}
 *       (comma-separated, case-insensitive); otherwise {@code Role.USER}.&lt;/li&gt;
 *   &lt;li&gt;Builds a {@link DefaultOidcUser} that &lt;b&gt;adds&lt;/b&gt; {@code ROLE_*} to the provider
 *       authorities and uses the email as the principal name attribute.&lt;/li&gt;
 * &lt;/ol&gt;
 * Keeping the principal name as the email ensures logs and security traces show the email
 * instead of the OIDC subject (&quot;sub&quot;).&lt;/p&gt;
 */
@Service
public class CustomOidcUserService implements OAuth2UserService&lt;OidcUserRequest, OidcUser&gt; {

    private final AppUserRepository userRepository;

<span class="nc" id="L52">    public CustomOidcUserService(AppUserRepository userRepository) {</span>
<span class="nc" id="L53">        this.userRepository = userRepository;</span>
<span class="nc" id="L54">    }</span>

    /** Reads APP_ADMIN_EMAILS (comma-separated, case-insensitive) into a lowercase set. */
    private static Set&lt;String&gt; readAdminAllowlist() {
<span class="nc" id="L58">        String raw = System.getenv().getOrDefault(&quot;APP_ADMIN_EMAILS&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L59" title="All 4 branches missed.">        if (raw == null || raw.isBlank()) return Collections.emptySet();</span>
<span class="nc" id="L60">        return Arrays.stream(raw.split(&quot;,&quot;))</span>
<span class="nc" id="L61">            .map(String::trim)</span>
<span class="nc bnc" id="L62" title="All 2 branches missed.">            .filter(s -&gt; !s.isEmpty())</span>
<span class="nc" id="L63">            .map(String::toLowerCase)</span>
<span class="nc" id="L64">            .collect(Collectors.toCollection(LinkedHashSet::new));</span>
    }

    private static String toRoleAuthority(Role role) {
<span class="nc bnc" id="L68" title="All 2 branches missed.">        String name = (role == null) ? &quot;USER&quot; : role.name();</span>
<span class="nc bnc" id="L69" title="All 2 branches missed.">        return name.startsWith(&quot;ROLE_&quot;) ? name : &quot;ROLE_&quot; + name;</span>
    }

    @Override
    public OidcUser loadUser(OidcUserRequest request) throws OAuth2AuthenticationException {
        // Delegate to the default loader first
<span class="nc" id="L75">        OidcUser oidc = new OidcUserService().loadUser(request);</span>

<span class="nc" id="L77">        final String email = oidc.getEmail(); // same as oidc.getAttribute(&quot;email&quot;)</span>
<span class="nc" id="L78">        final String name  = oidc.getFullName(); // falls back to &quot;name&quot; claim if present</span>

<span class="nc bnc" id="L80" title="All 4 branches missed.">        if (email == null || email.isBlank()) {</span>
<span class="nc" id="L81">            throw new OAuth2AuthenticationException(&quot;Email not provided by OAuth2 provider.&quot;);</span>
        }

        // Decide role from env allow-list (same helper you already use)
<span class="nc" id="L85">        final boolean isAdmin = readAdminAllowlist().contains(email.toLowerCase());</span>

        // ---- FIND OR CREATE BY *EMAIL* (not by id) ----
<span class="nc" id="L88">        AppUser user = userRepository.findByEmail(email).orElseGet(() -&gt; {</span>
<span class="nc" id="L89">            AppUser u = new AppUser();                           // let JPA manage UUID id</span>
<span class="nc" id="L90">            u.setEmail(email);</span>
<span class="nc bnc" id="L91" title="All 4 branches missed.">            u.setName((name == null || name.isBlank()) ? email : name);</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">            u.setRole(isAdmin ? Role.ADMIN : Role.USER);</span>
<span class="nc" id="L93">            u.setCreatedAt(LocalDateTime.now());</span>
            try {
<span class="nc" id="L95">                return userRepository.save(u);</span>
<span class="nc" id="L96">            } catch (DataIntegrityViolationException e) {</span>
                // Another request created it concurrently, or it already existed -&gt; re-fetch by EMAIL
<span class="nc" id="L98">                return userRepository.findByEmail(email).orElseThrow(() -&gt; e);</span>
            }
        });

        // Heal role if the allow-list changed since last login
<span class="nc bnc" id="L103" title="All 2 branches missed.">        final Role desired = isAdmin ? Role.ADMIN : Role.USER;</span>
<span class="nc bnc" id="L104" title="All 2 branches missed.">        if (user.getRole() != desired) {</span>
<span class="nc" id="L105">            user.setRole(desired);</span>
<span class="nc" id="L106">            userRepository.save(user);</span>
        }

        // Merge ROLE_* into authorities so hasRole(...) works across the app
<span class="nc" id="L110">        var authorities = new java.util.ArrayList&lt;GrantedAuthority&gt;(oidc.getAuthorities());</span>
<span class="nc" id="L111">        authorities.add(new SimpleGrantedAuthority(toRoleAuthority(user.getRole())));</span>

        // Prefer &quot;email&quot; as the principal name (so logs &amp; SecurityContext name show the email)
<span class="nc" id="L114">        return new DefaultOidcUser(</span>
            authorities,
<span class="nc" id="L116">            oidc.getIdToken(),</span>
<span class="nc" id="L117">            oidc.getUserInfo(),</span>
            &quot;email&quot;
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>