<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CustomOidcUserService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.smartsupplypro.inventory.service</a> &gt; <span class="el_source">CustomOidcUserService.java</span></div><h1>CustomOidcUserService.java</h1><pre class="source lang-java linenums">package com.smartsupplypro.inventory.service;

import java.time.LocalDateTime;
import java.util.Arrays;
import java.util.Collections;
import java.util.LinkedHashSet;
import java.util.Set;
import java.util.stream.Collectors;

import org.springframework.dao.DataIntegrityViolationException;
import org.springframework.security.core.GrantedAuthority;
import org.springframework.security.core.authority.SimpleGrantedAuthority;
import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserRequest;
import org.springframework.security.oauth2.client.oidc.userinfo.OidcUserService;
import org.springframework.security.oauth2.client.userinfo.OAuth2UserService;
import org.springframework.security.oauth2.core.OAuth2AuthenticationException;
import org.springframework.security.oauth2.core.oidc.user.DefaultOidcUser;
import org.springframework.security.oauth2.core.oidc.user.OidcUser;
import org.springframework.stereotype.Service;

import com.smartsupplypro.inventory.model.AppUser;
import com.smartsupplypro.inventory.model.Role;
import com.smartsupplypro.inventory.repository.AppUserRepository;

/**
 * OIDC user service for OpenID Connect providers with automatic role assignment.
 *
 * &lt;p&gt;&lt;strong&gt;Characteristics&lt;/strong&gt;:
 * &lt;ul&gt;
 *   &lt;li&gt;&lt;strong&gt;OIDC Support&lt;/strong&gt;: Handles OpenID Connect flow (e.g., Google with openid scope)&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;Auto-Provisioning&lt;/strong&gt;: Creates local user on first OIDC login&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;Role Assignment&lt;/strong&gt;: ADMIN via APP_ADMIN_EMAILS env var, otherwise USER&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;Email-Based Identity&lt;/strong&gt;: Uses email as principal for security context&lt;/li&gt;
 *   &lt;li&gt;&lt;strong&gt;Role Healing&lt;/strong&gt;: Updates role if allow-list changes&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * &lt;p&gt;&lt;strong&gt;Why Separate from OAuth2UserService&lt;/strong&gt;:
 * OIDC requires {@code OAuth2UserService&lt;OidcUserRequest, OidcUser&gt;} parametrization.
 * Without this, role mapping ({@code ROLE_ADMIN}/{@code ROLE_USER}) wouldn't apply to OIDC logins.
 *
 * &lt;p&gt;&lt;strong&gt;Configuration&lt;/strong&gt;:
 * Set {@code APP_ADMIN_EMAILS} environment variable with comma-separated admin emails.
 *
 * @see AppUser
 * @see CustomOAuth2UserService
 */
@Service
public class CustomOidcUserService implements OAuth2UserService&lt;OidcUserRequest, OidcUser&gt; {

    private final AppUserRepository userRepository;

<span class="fc" id="L52">    public CustomOidcUserService(AppUserRepository userRepository) {</span>
<span class="fc" id="L53">        this.userRepository = userRepository;</span>
<span class="fc" id="L54">    }</span>

    /**
     * Reads admin allow-list from APP_ADMIN_EMAILS environment variable.
     *
     * @return set of lowercase admin emails
     */
    private static Set&lt;String&gt; readAdminAllowlist() {
<span class="nc" id="L62">        String raw = System.getenv().getOrDefault(&quot;APP_ADMIN_EMAILS&quot;, &quot;&quot;);</span>
<span class="nc bnc" id="L63" title="All 4 branches missed.">        if (raw == null || raw.isBlank()) return Collections.emptySet();</span>
<span class="nc" id="L64">        return Arrays.stream(raw.split(&quot;,&quot;))</span>
<span class="nc" id="L65">            .map(String::trim)</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">            .filter(s -&gt; !s.isEmpty())</span>
<span class="nc" id="L67">            .map(String::toLowerCase)</span>
<span class="nc" id="L68">            .collect(Collectors.toCollection(LinkedHashSet::new));</span>
    }

    /**
     * Normalizes role to Spring Security authority format.
     *
     * @param role user role
     * @return ROLE_* authority string
     */
    private static String toRoleAuthority(Role role) {
<span class="nc bnc" id="L78" title="All 2 branches missed.">        String name = (role == null) ? &quot;USER&quot; : role.name();</span>
<span class="nc bnc" id="L79" title="All 2 branches missed.">        return name.startsWith(&quot;ROLE_&quot;) ? name : &quot;ROLE_&quot; + name;</span>
    }

    /**
     * Loads OIDC user and assigns ROLE_ADMIN or ROLE_USER based on APP_ADMIN_EMAILS.
     *
     * @param request OIDC user request
     * @return OIDC user with role-based authority
     * @throws OAuth2AuthenticationException if email missing or user creation fails
     */
    @Override
    public OidcUser loadUser(OidcUserRequest request) throws OAuth2AuthenticationException {
        // Enterprise Comment: OIDC User Loading
        // Delegate to OidcUserService to handle ID token validation and claims extraction.
        // This ensures OpenID Connect standards (JWT signature, issuer validation, nonce) are enforced.
<span class="nc" id="L94">        OidcUser oidc = new OidcUserService().loadUser(request);</span>

<span class="nc" id="L96">        final String email = oidc.getEmail(); // same as oidc.getAttribute(&quot;email&quot;)</span>
<span class="nc" id="L97">        final String name  = oidc.getFullName(); // falls back to &quot;name&quot; claim if present</span>

<span class="nc bnc" id="L99" title="All 4 branches missed.">        if (email == null || email.isBlank()) {</span>
<span class="nc" id="L100">            throw new OAuth2AuthenticationException(&quot;Email not provided by OAuth2 provider.&quot;);</span>
        }

        // Enterprise Comment: Environment-Based Role Assignment
        // APP_ADMIN_EMAILS allows zero-downtime role changes without code deployment.
        // Example: APP_ADMIN_EMAILS=admin@corp.com,manager@corp.com
<span class="nc" id="L106">        final boolean isAdmin = readAdminAllowlist().contains(email.toLowerCase());</span>

        // Enterprise Comment: Auto-Provisioning Pattern
        // Create user on first login with role based on email allow-list.
        // Race condition handling: If concurrent login creates duplicate, re-fetch by email.
<span class="nc" id="L111">        AppUser user = userRepository.findByEmail(email).orElseGet(() -&gt; {</span>
<span class="nc" id="L112">            AppUser u = new AppUser();                           // let JPA manage UUID id</span>
<span class="nc" id="L113">            u.setEmail(email);</span>
<span class="nc bnc" id="L114" title="All 4 branches missed.">            u.setName((name == null || name.isBlank()) ? email : name);</span>
<span class="nc bnc" id="L115" title="All 2 branches missed.">            u.setRole(isAdmin ? Role.ADMIN : Role.USER);</span>
<span class="nc" id="L116">            u.setCreatedAt(LocalDateTime.now());</span>
            try {
<span class="nc" id="L118">                return userRepository.save(u);</span>
<span class="nc" id="L119">            } catch (DataIntegrityViolationException e) {</span>
                // Another request created it concurrently, or it already existed -&gt; re-fetch by EMAIL
<span class="nc" id="L121">                return userRepository.findByEmail(email).orElseThrow(() -&gt; e);</span>
            }
        });

        // Enterprise Comment: Role Healing Pattern
        // Update role if APP_ADMIN_EMAILS changed since last login (idempotent operation).
<span class="nc bnc" id="L127" title="All 2 branches missed.">        final Role desired = isAdmin ? Role.ADMIN : Role.USER;</span>
<span class="nc bnc" id="L128" title="All 2 branches missed.">        if (user.getRole() != desired) {</span>
<span class="nc" id="L129">            user.setRole(desired);</span>
<span class="nc" id="L130">            userRepository.save(user);</span>
        }

        // Merge ROLE_* into authorities so hasRole(...) works across the app
<span class="nc" id="L134">        var authorities = new java.util.ArrayList&lt;GrantedAuthority&gt;(oidc.getAuthorities());</span>
<span class="nc" id="L135">        authorities.add(new SimpleGrantedAuthority(toRoleAuthority(user.getRole())));</span>

        // Prefer &quot;email&quot; as the principal name (so logs &amp; SecurityContext name show the email)
<span class="nc" id="L138">        return new DefaultOidcUser(</span>
            authorities,
<span class="nc" id="L140">            oidc.getIdToken(),</span>
<span class="nc" id="L141">            oidc.getUserInfo(),</span>
            &quot;email&quot;
        );
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>