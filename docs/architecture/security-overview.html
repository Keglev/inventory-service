<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Security Overview ‚Äì SmartSupplyPro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="Security architecture for SmartSupplyPro (OAuth2, sessions, CORS, CSRF, roles)." />
  <link rel="icon" href="https://keglev.github.io/inventory-service/favicon.ico" />
  <style>
    body { margin: 0; font-family: system-ui, sans-serif; background: #fafafa; color: #111; }
    header { background-color: #0d1117; color: white; padding: 1rem 2rem;
             display: flex; justify-content: space-between; align-items: center; }
    nav { background: #f3f4f6; padding: 1rem 2rem; }
    nav a { margin-right: 1.5rem; text-decoration: none; font-weight: 500; color: #0366d6; }
    nav a:hover { text-decoration: underline; }
    main { max-width: 900px; margin: 2rem auto; padding: 0 2rem; line-height: 1.6; }
    main h1, main h2, main h3 { color: #0d1117; }
    pre, code { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas,
                "Liberation Mono", "Courier New", monospace; background: #f6f8fa;
                border-radius: 6px; padding: 0.2rem 0.4rem; }
    pre { padding: 1rem; overflow: auto; }
    footer { text-align: center; padding: 2rem; font-size: 0.875rem; color: #666; }
  </style>
</head>
<body>
  <header>
    <h1>üîê Security Overview</h1>
    <a href="https://github.com/Keglev/inventory-service" target="_blank" style="color: #58a6ff;">View on GitHub ‚Üó</a>
  </header>
  <nav>
    <a href="../index.html">üè† Home</a>
    <a href="../api.html">üìò API Reference</a>
  </nav>
  <main>
    <h1>Security Overview</h1>
<p>This document summarizes how <strong>authentication</strong>, <strong>authorization</strong>, <strong>cookies/sessions</strong>, <strong>CORS</strong>, <strong>CSRF</strong>, <strong>health endpoints</strong>, and <strong>testing</strong> are implemented in the <strong>Inventory Service</strong> (SmartSupplyPro) stack.</p>
<hr>
<h2>1) Authentication (Google OAuth2 + Spring Security)</h2>
<ul>
<li><strong>Flow</strong>: Browser ‚Üí Google OAuth (authorization code) ‚Üí Backend exchanges code for tokens ‚Üí App establishes a <strong>server session</strong>.</li>
<li><strong>Framework</strong>: Spring Security (OAuth2 Client).</li>
<li><strong>User model</strong>: On first successful login:<ul>
<li>Lookup <code>AppUser</code> by email.</li>
<li>Create if missing with role <code>USER</code>.</li>
<li>No self-service signup; admin elevation is manual.</li>
</ul>
</li>
<li><strong>Session</strong>: Server-side session cookie (no JWT). See ‚ÄúCookies &amp; Sessions‚Äù.</li>
</ul>
<h3>OAuth2 details</h3>
<ul>
<li>Authorization endpoint: <code>https://accounts.google.com/o/oauth2/v2/auth</code>  </li>
<li>Token endpoint: <code>https://oauth2.googleapis.com/token</code>  </li>
<li>Scopes: <code>openid</code>, <code>profile</code>, <code>email</code></li>
</ul>
<hr>
<h2>2) Authorization (Endpoint Access Rules)</h2>
<p>Access control is enforced centrally in <code>SecurityConfig</code>.</p>
<p><strong>Public</strong></p>
<ul>
<li><code>/</code></li>
<li><code>/health/**</code>, <code>/actuator/**</code></li>
<li>OAuth routes: <code>/oauth2/**</code>, <code>/login/**</code>, <code>/login/oauth2/**</code>, <code>/error</code></li>
</ul>
<p><strong>Authenticated</strong></p>
<ul>
<li><code>/api/**</code> (valid session required)</li>
</ul>
<p><strong>Admin only</strong></p>
<ul>
<li><code>/api/admin/**</code> (requires <code>ADMIN</code> authority)</li>
</ul>
<p>Method security is enabled with <code>@EnableMethodSecurity</code>, so you can gate methods like:</p>
<pre><code class="language-java">@PreAuthorize(&quot;hasAuthority(&#39;ADMIN&#39;)&quot;)

## 3 Error Handling (API vs Browser)
We return different responses based on request type:

- API requests (path starts with /api/ and Accept: application/json)

- Unauthenticated ‚Üí 401 with JSON body:

  ## { &quot;message&quot;: &quot;Unauthorized&quot; }

  ## Browser requests

## Unauthenticated ‚Üí 302 redirect to /oauth2/authorization/google.

## 4 Cookies &amp; Sessions

- Auth model: Server-side session (no JWT).

- Cookie: configured via CookieSerializer

- SameSite=None

- Secure=true

- Path=/

**Why: Enables cross-site cookie usage from the SPA origin over HTTPS.**

- Logout: POST /logout (or GET if enabled) invalidates session and deletes JSESSIONID / SESSION.

- Example Set-Cookie (conceptual)

  ## Set-Cookie: SESSION=abc123; Path=/; Secure; SameSite=None; HttpOnly

### OpenAPI note
- Document session usage by requiring cookieAuth on secured operations (see Section 2). No token is sent in headers or query string.

## 5 CORS
CORS is configured to support the dev SPA and production frontend.

**Allowed origins**

- http://localhost:5173

- https://localhost:5173 (if used)

- https://inventoryfrontend.fly.dev (update when prod URL changes)

- Allowed methods: GET, POST, PUT, PATCH, DELETE, OPTIONS

- Allowed headers: *

- Exposed headers: Set-Cookie

- Credentials: true

- Max age: 3600 seconds

## Preflight example

  OPTIONS /api/items
  Origin: http://localhost:5173
  Access-Control-Request-Method: GET

## Expected response headers

HTTP/1.1 200 OK
Access-Control-Allow-Origin: http://localhost:5173
Access-Control-Allow-Methods: GET,POST,PUT,PATCH,DELETE,OPTIONS
Access-Control-Allow-Headers: *
Access-Control-Allow-Credentials: true
Vary: Origin

## 6 CSRF
- Current project choice: CSRF disabled globally (portfolio simplification).

- Production guidance:

  - Prefer enabling CSRF.

  - Exempt pure REST routes (/api/) or use CSRF tokens for browser-submitted forms.

  - Keep OAuth login and logout flows compatible with your CSRF model.

**No OpenAPI change is needed for CSRF; it‚Äôs a transport/browser concern**.

## 7 Health Endpoints
- Public, lightweight:

  - /health (simple 200 OK‚Äîno DB calls)

  - If Actuator is enabled: /actuator/health

## DB-specific checks:

- Keep separate (e.g., /health/db) and understand they may fail due to upstream allowlists.

- If exposing DB checks publicly, make responses minimal (no secrets) and document potential failure modes.

## 8 Testing Strategy (Security)
Focus on slice tests that load your real SecurityConfig but only stub controllers as needed.

### What to verify

- /api/admin/:

  - ADMIN ‚Üí 200

  - USER ‚Üí 403

- Unauthenticated API request ‚Üí 401 JSON ({&quot;message&quot;:&quot;Unauthorized&quot;})

- /oauth2/authorization/google is permitted (3xx)

- CORS preflight from dev origin succeeds and includes
  - Access-Control-Allow-Origin and Access-Control-Allow-Credentials: true

**MockMvc snippets**

// ADMIN can access admin endpoints
@WithMockUser(authorities = &quot;ADMIN&quot;)
mvc.perform(get(&quot;/api/admin/ping&quot;).accept(MediaType.APPLICATION_JSON))
   .andExpect(status().isOk());

// USER is forbidden on admin endpoints
@WithMockUser(authorities = &quot;USER&quot;)
mvc.perform(get(&quot;/api/admin/ping&quot;).accept(MediaType.APPLICATION_JSON))
   .andExpect(status().isForbidden());

// Unauthenticated API request ‚Üí 401 JSON (not a redirect)
mvc.perform(get(&quot;/api/items&quot;).accept(MediaType.APPLICATION_JSON))
   .andExpect(status().isUnauthorized())
   .andExpect(content().contentType(MediaType.APPLICATION_JSON))
   .andExpect(content().json(&quot;{\&quot;message\&quot;:\&quot;Unauthorized\&quot;}&quot;));

// OAuth authorization endpoint is permitted
mvc.perform(get(&quot;/oauth2/authorization/google&quot;))
   .andExpect(status().is3xxRedirection());

// CORS preflight for dev origin
mvc.perform(options(&quot;/api/items&quot;)
        .header(&quot;Origin&quot;, &quot;http://localhost:5173&quot;)
        .header(&quot;Access-Control-Request-Method&quot;, &quot;GET&quot;))
   .andExpect(status().isOk())
   .andExpect(header().string(&quot;Access-Control-Allow-Origin&quot;, &quot;http://localhost:5173&quot;))
   .andExpect(header().string(&quot;Access-Control-Allow-Credentials&quot;, &quot;true&quot;));


 Each OpenAPI spec declares:
```yaml
components:
  securitySchemes:
    OAuth2:
      type: oauth2
      flows:
        authorizationCode:
          authorizationUrl: https://accounts.google.com/o/oauth2/v2/auth
          tokenUrl: https://oauth2.googleapis.com/token
          scopes:
            openid: OpenID Connect scope
            profile: Access basic profile
            email: Access email
</code></pre>

  </main>
  <footer>¬© 2025 SmartSupplyPro ‚Äì Security Overview</footer>
</body>
</html>