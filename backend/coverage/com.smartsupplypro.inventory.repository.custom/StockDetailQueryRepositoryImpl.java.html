<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>StockDetailQueryRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.smartsupplypro.inventory.repository.custom</a> &gt; <span class="el_source">StockDetailQueryRepositoryImpl.java</span></div><h1>StockDetailQueryRepositoryImpl.java</h1><pre class="source lang-java linenums">package com.smartsupplypro.inventory.repository.custom;

import java.time.LocalDateTime;
import java.util.List;

import org.springframework.stereotype.Repository;

import com.smartsupplypro.inventory.dto.StockEventRowDTO;
import com.smartsupplypro.inventory.repository.custom.util.DatabaseDialectDetector;

import jakarta.persistence.EntityManager;
import jakarta.persistence.PersistenceContext;
import jakarta.persistence.Query;

/**
 * Detail query repository implementation with multi-database support.
 *
 * &lt;p&gt;Encapsulates complex filtering logic and JPQL event streaming for
 * audit trails and cost-flow calculations across H2 and Oracle.
 *
 * @author Smart Supply Pro Development Team
 * @version 1.0.0
 * @since 2.0.0
 */
@Repository
public class StockDetailQueryRepositoryImpl implements StockDetailQueryRepository {

    @PersistenceContext
    private EntityManager em;

    private final DatabaseDialectDetector dialectDetector;

<span class="fc" id="L33">    public StockDetailQueryRepositoryImpl(DatabaseDialectDetector dialectDetector) {</span>
<span class="fc" id="L34">        this.dialectDetector = dialectDetector;</span>
<span class="fc" id="L35">    }</span>

    /**
     * Searches stock updates with flexible filtering across supported databases.
     * Supports H2 and Oracle with optimized SQL per dialect.
     * @param startDate   filter start date (inclusive)
     * @param endDate     filter end date (inclusive)
     * @param itemName    partial item name (case-insensitive, optional)
     * @param supplierId  exact supplier ID (optional)
     * @param createdBy   exact creator username (case-insensitive, optional)
     * @param minChange   minimum change value (optional)
     * @param maxChange   maximum change value (optional)
     */
    @SuppressWarnings(&quot;unchecked&quot;)
    @Override
    public List&lt;Object[]&gt; searchStockUpdates(
        LocalDateTime startDate,
        LocalDateTime endDate,
        String itemName,
        String supplierId,
        String createdBy,
        Integer minChange,
        Integer maxChange
    ) {
<span class="pc bpc" id="L59" title="1 of 2 branches missed.">        final String sql = dialectDetector.isH2()</span>
<span class="fc" id="L60">            ? buildH2FilteredSearchSql()</span>
<span class="pc" id="L61">            : buildOracleFilteredSearchSql();</span>

        // Normalize optional parameters for NULL-safe SQL filtering
<span class="pc bpc" id="L64" title="2 of 4 branches missed.">        final String itemPattern = (itemName == null || itemName.isBlank())</span>
<span class="pc" id="L65">            ? null : &quot;%&quot; + itemName.toLowerCase() + &quot;%&quot;;</span>
<span class="fc" id="L66">        final String normalizedSupplier = normalizeOptionalParam(supplierId);</span>
<span class="pc bpc" id="L67" title="2 of 4 branches missed.">        final String normalizedCreator = (createdBy == null || createdBy.isBlank())</span>
<span class="pc" id="L68">            ? null : createdBy.toLowerCase();</span>

<span class="fc" id="L70">        final Query query = em.createNativeQuery(sql);</span>
<span class="fc" id="L71">        query.setParameter(&quot;startDate&quot;, startDate);</span>
<span class="fc" id="L72">        query.setParameter(&quot;endDate&quot;, endDate);</span>
<span class="fc" id="L73">        query.setParameter(&quot;itemPattern&quot;, itemPattern);</span>
<span class="fc" id="L74">        query.setParameter(&quot;supplierId&quot;, normalizedSupplier);</span>
<span class="fc" id="L75">        query.setParameter(&quot;createdByNorm&quot;, normalizedCreator);</span>
<span class="fc" id="L76">        query.setParameter(&quot;minChange&quot;, minChange);</span>
<span class="fc" id="L77">        query.setParameter(&quot;maxChange&quot;, maxChange);</span>

<span class="fc" id="L79">        return query.getResultList();</span>
    }

    /**
     * Streams stock events up to a specified end time for WAC calculations.
     * Uses JPQL for database-agnostic entity querying.
     * @param end         upper timestamp bound (inclusive)
     * @param supplierId  optional supplier ID filter
     * @return list of stock event rows for WAC processing
     * @see StockEventRowDTO
     */
    @Override
    public List&lt;StockEventRowDTO&gt; streamEventsForWAC(LocalDateTime end, String supplierId) {
        // Use JPQL for entity-based event streaming (database-agnostic)
<span class="fc" id="L93">        final String jpql = &quot;&quot;&quot;</span>
            SELECT new com.smartsupplypro.inventory.dto.StockEventRowDTO(
                sh.itemId, 
                COALESCE(sh.supplierId, i.supplierId), 
                sh.timestamp, 
                sh.change,
                sh.priceAtChange,
                sh.reason
            )
            FROM StockHistory sh, InventoryItem i
            WHERE i.id = sh.itemId 
              AND sh.timestamp &lt;= :end
              AND (:supplierIdNorm IS NULL OR LOWER(sh.supplierId) = :supplierIdNorm)
            ORDER BY sh.itemId ASC, sh.timestamp ASC
        &quot;&quot;&quot;;

<span class="pc bpc" id="L109" title="2 of 4 branches missed.">        final String supplierIdNorm = (supplierId == null || supplierId.isBlank())</span>
<span class="pc" id="L110">            ? null : supplierId.trim().toLowerCase();</span>

<span class="fc" id="L112">        return em.createQuery(jpql, StockEventRowDTO.class)</span>
<span class="fc" id="L113">                .setParameter(&quot;end&quot;, end)</span>
<span class="fc" id="L114">                .setParameter(&quot;supplierIdNorm&quot;, supplierIdNorm)</span>
<span class="fc" id="L115">                .getResultList();</span>
    }

    /**
     * Builds the SQL query for filtered search on H2 database.
     * @return SQL query string
     * @see #buildOracleFilteredSearchSql()
     */
    private String buildH2FilteredSearchSql() {
<span class="fc" id="L124">        return &quot;&quot;&quot;</span>
            SELECT i.name AS item_name, 
                   s.name AS supplier_name, 
                   sh.quantity_change, 
                   sh.reason, 
                   sh.created_by, 
                   sh.created_at
            FROM stock_history sh
            JOIN inventory_item i ON sh.item_id = i.id
            JOIN supplier s ON i.supplier_id = s.id
            WHERE (:startDate IS NULL OR sh.created_at &gt;= :startDate)
              AND (:endDate IS NULL OR sh.created_at &lt;= :endDate)
              AND (:itemPattern IS NULL OR LOWER(i.name) LIKE :itemPattern)
              AND (:supplierId IS NULL OR UPPER(i.supplier_id) = UPPER(:supplierId))
              AND (:createdByNorm IS NULL OR LOWER(sh.created_by) = :createdByNorm)
              AND (:minChange IS NULL OR sh.quantity_change &gt;= :minChange)
              AND (:maxChange IS NULL OR sh.quantity_change &lt;= :maxChange)
            ORDER BY sh.created_at DESC
        &quot;&quot;&quot;;
    }

    /**
     * Builds the SQL query for filtered search on Oracle database.
     * @return SQL query string
     * @see #buildH2FilteredSearchSql()
     */
    private String buildOracleFilteredSearchSql() {
<span class="nc" id="L151">        return &quot;&quot;&quot;</span>
            SELECT i.name AS item_name, 
                   s.name AS supplier_name, 
                   sh.quantity_change, 
                   sh.reason, 
                   sh.created_by, 
                   sh.created_at
            FROM stock_history sh
            JOIN inventory_item i ON sh.item_id = i.id
            JOIN supplier s ON i.supplier_id = s.id
            WHERE (:startDate IS NULL OR sh.created_at &gt;= :startDate)
              AND (:endDate IS NULL OR sh.created_at &lt;= :endDate)
              AND (:itemPattern IS NULL OR LOWER(i.name) LIKE :itemPattern)
              AND (:supplierId IS NULL OR i.supplier_id = :supplierId)
              AND (:createdByNorm IS NULL OR LOWER(sh.created_by) = :createdByNorm)
              AND (:minChange IS NULL OR sh.quantity_change &gt;= :minChange)
              AND (:maxChange IS NULL OR sh.quantity_change &lt;= :maxChange)
            ORDER BY sh.created_at DESC
        &quot;&quot;&quot;;
    }

    /* ======================================================================
     * Utility Methods
     * ====================================================================== */

    /** Normalizes optional string parameters (null/blank â†’ null). 
     * @param param input parameter
     * @return normalized parameter 
     * @see #searchStockUpdates(LocalDateTime, LocalDateTime, String, String, String, Integer, Integer)
    */
    private String normalizeOptionalParam(String param) {
<span class="pc bpc" id="L182" title="2 of 4 branches missed.">        return (param == null || param.isBlank()) ? null : param.trim();</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>