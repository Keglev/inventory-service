<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AnalyticsConverterHelper.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Inventory Service</a> &gt; <a href="index.source.html" class="el_package">com.smartsupplypro.inventory.service.impl.analytics</a> &gt; <span class="el_source">AnalyticsConverterHelper.java</span></div><h1>AnalyticsConverterHelper.java</h1><pre class="source lang-java linenums">package com.smartsupplypro.inventory.service.impl.analytics;

import java.sql.Timestamp;
import java.time.LocalDate;
import java.time.LocalDateTime;
import java.time.LocalTime;

import com.smartsupplypro.inventory.exception.InvalidRequestException;

/**
 * Type conversion utilities for analytics database projections.
 *
 * &lt;p&gt;Handles type coercion from native SQL queries (Object[] projections) to Java types,
 * accounting for vendor differences between H2 (test) and Oracle (prod).
 *
 * &lt;p&gt;&lt;strong&gt;Supported Conversions&lt;/strong&gt;:
 * &lt;ul&gt;
 *   &lt;li&gt;DATE/TIMESTAMP → LocalDate/LocalDateTime&lt;/li&gt;
 *   &lt;li&gt;Numeric projections → Number (handles null as zero)&lt;/li&gt;
 *   &lt;li&gt;String normalization (blank → null)&lt;/li&gt;
 *   &lt;li&gt;Date window defaults (30-day lookback)&lt;/li&gt;
 * &lt;/ul&gt;
 *
 * @author Smart Supply Pro Development Team
 * @version 1.0.0
 * @since 2.0.0
 */
final class AnalyticsConverterHelper {

    private AnalyticsConverterHelper() {
        // Utility class - prevent instantiation
    }

    // ==================================================================================
    // Date/Time Conversions
    // ==================================================================================

    /**
     * Converts a date-like value to {@link LocalDate}.
     *
     * &lt;p&gt;Accepts:
     * &lt;ul&gt;
     *   &lt;li&gt;{@link LocalDate}&lt;/li&gt;
     *   &lt;li&gt;{@link java.sql.Date} (converted via {@code toLocalDate()})&lt;/li&gt;
     *   &lt;li&gt;{@link java.sql.Timestamp} (converted via {@code toLocalDateTime().toLocalDate()})&lt;/li&gt;
     *   &lt;li&gt;{@link CharSequence} in formats starting with {@code yyyy-MM-dd}&lt;/li&gt;
     * &lt;/ul&gt;
     *
     * @param o raw value from native projections (DATE/TIMESTAMP/STRING)
     * @return the corresponding {@link LocalDate}
     * @throws IllegalStateException if the value cannot be interpreted as a date
     */
    static LocalDate asLocalDate(Object o) {
<span class="pc bpc" id="L54" title="1 of 2 branches missed.">        if (o instanceof LocalDate ld) return ld;</span>
<span class="pc bpc" id="L55" title="1 of 2 branches missed.">        if (o instanceof java.sql.Date d) return d.toLocalDate();</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (o instanceof java.sql.Timestamp ts) return ts.toLocalDateTime().toLocalDate();</span>

<span class="nc bnc" id="L58" title="All 2 branches missed.">        if (o instanceof CharSequence cs) {</span>
<span class="nc" id="L59">            String s = cs.toString();</span>
<span class="nc bnc" id="L60" title="All 2 branches missed.">            if (s.length() &gt;= 10) {</span>
                // e.g. &quot;2025-03-15 00:00:00.0&quot; → &quot;2025-03-15&quot;
<span class="nc" id="L62">                return LocalDate.parse(s.substring(0, 10));</span>
            }
        }

        // Last resort: try toString().substring(0,10) if it looks like a timestamp literal
<span class="nc" id="L67">        String s = String.valueOf(o);</span>
<span class="nc bnc" id="L68" title="All 8 branches missed.">        if (s != null &amp;&amp; s.length() &gt;= 10 &amp;&amp; s.charAt(4) == '-' &amp;&amp; s.charAt(7) == '-') {</span>
<span class="nc" id="L69">            return LocalDate.parse(s.substring(0, 10));</span>
        }

<span class="nc" id="L72">        throw new IllegalStateException(&quot;Expected LocalDate/Date/Timestamp/String but got: &quot; +</span>
<span class="nc bnc" id="L73" title="All 2 branches missed.">                (o == null ? &quot;null&quot; : o.getClass().getName() + &quot; -&gt; &quot; + o));</span>
    }

    /**
     * Converts a timestamp-like object to {@link LocalDateTime}.
     *
     * @param o timestamp value (LocalDateTime or java.sql.Timestamp)
     * @return the corresponding {@link LocalDateTime}
     * @throws IllegalStateException if the object type is unsupported
     */
    static LocalDateTime asLocalDateTime(Object o) {
<span class="fc bfc" id="L84" title="All 2 branches covered.">        if (o instanceof LocalDateTime ldt) return ldt;</span>
<span class="pc bpc" id="L85" title="1 of 2 branches missed.">        if (o instanceof Timestamp ts) return ts.toLocalDateTime();</span>
<span class="nc" id="L86">        throw new IllegalStateException(&quot;Expected LocalDateTime or java.sql.Timestamp but got: &quot; + o);</span>
    }

    /**
     * Safely unboxes any numeric projection value via {@link Number}.
     *
     * @param o numeric value (null, Number, or BigDecimal)
     * @return the corresponding {@link Number} (null treated as zero)
     */
    static Number asNumber(Object o) {
<span class="pc bpc" id="L96" title="1 of 2 branches missed.">        if (o == null) return java.math.BigDecimal.ZERO;</span>
<span class="fc bfc" id="L97" title="All 2 branches covered.">        if (o instanceof Number n) return n;</span>
<span class="pc bpc" id="L98" title="1 of 2 branches missed.">        if (o instanceof java.math.BigDecimal bd) return bd;</span>
<span class="fc" id="L99">        throw new IllegalStateException(&quot;Expected numeric type but got: &quot; + o);</span>
    }

    // ==================================================================================
    // Date Window Utilities
    // ==================================================================================

    /**
     * Applies defaults for a date window (last 30 days ending today) and validates {@code start &lt;= end}.
     *
     * @param start nullable inclusive start date
     * @param end nullable inclusive end date
     * @return a 2-element array containing the effective start and end
     * @throws InvalidRequestException if the effective start is after the effective end
     */
    static LocalDate[] defaultAndValidateDateWindow(LocalDate start, LocalDate end) {
<span class="fc bfc" id="L115" title="All 2 branches covered.">        LocalDate s = (start == null) ? LocalDate.now().minusDays(30) : start;</span>
<span class="fc bfc" id="L116" title="All 2 branches covered.">        LocalDate e = (end == null) ? LocalDate.now() : end;</span>
<span class="fc bfc" id="L117" title="All 2 branches covered.">        if (s.isAfter(e)) {</span>
<span class="fc" id="L118">            throw new InvalidRequestException(&quot;start must be on or before end&quot;);</span>
        }
<span class="fc" id="L120">        return new LocalDate[]{s, e};</span>
    }

    /**
     * Converts date to start of day (00:00:00.000000000).
     *
     * @param d the date
     * @return LocalDateTime at start of day
     */
    static LocalDateTime startOfDay(LocalDate d) {
<span class="fc" id="L130">        return LocalDateTime.of(d, LocalTime.MIN);</span>
    }

    /**
     * Converts date to end of day (23:59:59.999999999).
     *
     * @param d the date
     * @return LocalDateTime at end of day
     */
    static LocalDateTime endOfDay(LocalDate d) {
<span class="fc" id="L140">        return LocalDateTime.of(d, LocalTime.MAX);</span>
    }

    // ==================================================================================
    // String Utilities
    // ==================================================================================

    /**
     * Normalizes a String to {@code null} if blank; otherwise returns a trimmed value.
     *
     * @param s the string to normalize
     * @return null if blank, trimmed value otherwise
     */
    static String blankToNull(String s) {
<span class="fc bfc" id="L154" title="All 4 branches covered.">        return (s == null || s.trim().isEmpty()) ? null : s.trim();</span>
    }

    /**
     * Ensures a String is non-blank; returns trimmed value or throws.
     *
     * @param v the value to check
     * @param name the parameter name for error message
     * @return trimmed non-blank value
     * @throws InvalidRequestException if value is blank
     */
    static String requireNonBlank(String v, String name) {
<span class="pc bpc" id="L166" title="1 of 4 branches missed.">        if (v == null || v.trim().isEmpty()) {</span>
<span class="fc" id="L167">            throw new InvalidRequestException(name + &quot; must not be blank&quot;);</span>
        }
<span class="fc" id="L169">        return v.trim();</span>
    }

    /**
     * Ensures a reference is non-null; returns it or throws.
     *
     * @param v the value to check
     * @param name the parameter name for error message
     * @return the non-null value
     * @throws InvalidRequestException if value is null
     */
    static &lt;T&gt; T requireNonNull(T v, String name) {
<span class="pc bpc" id="L181" title="1 of 2 branches missed.">        if (v == null) {</span>
<span class="nc" id="L182">            throw new InvalidRequestException(name + &quot; must not be null&quot;);</span>
        }
<span class="fc" id="L184">        return v;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.12.202403310830</span></div></body></html>