# =============================================================================
# Smart Supply Pro â€“ Production Deployment to Fly.io
#
# PIPELINE ROLE: Production deployment orchestration for backend service
#
# PURPOSE:
# - Deploy pre-built, security-scanned Docker images to Fly.io production
# - Provide controlled rollout options (immediate, canary, rolling)
# - Validate deployment health with automated health checks and smoke tests
# - Maintain deployment audit trail via GitHub Actions logs and Fly.io status
#
# TRIGGER MODES:
# 1. AUTOMATIC: Triggered after 1-ci-test.yml succeeds on main branch
#    - Image tag: commit SHA (from workflow_run.head_sha)
#    - Strategy: immediate (rollout all instances)
#    - Purpose: Production-ready image automatically deployed after CI passes
#
# 2. MANUAL: Via workflow_dispatch on any branch/ref
#    - Image tag: User-supplied (e.g., 'latest', 'v1.0.0', commit SHA)
#    - Strategy: User-selected (immediate, canary, rolling)
#    - Purpose: Emergency deploys, manual rollbacks, testing
#
# PREREQUISITES:
# âœ“ Docker image must exist in Docker Hub (built by 1-ci-test.yml)
# âœ“ Image must have passed Trivy HIGH/CRITICAL security scan
# âœ“ FLY_API_TOKEN secret configured in GitHub (with app deployment scope)
# âœ“ Fly.io app 'inventoryservice' provisioned with:
#   - Oracle Wallet mounted (ORACLE_WALLET_B64 secret, TNS_ADMIN=/app/wallet)
#   - Database credentials configured (DB_URL, DB_USER, DB_PASS secrets)
#   - OAuth2 provider secrets (GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET)
#   - App configuration (APP_DEMO_READONLY, APP_FRONTEND_BASE_URL, etc.)
#
# DEPLOYMENT PHASES:
# 1. Validation: Verify image exists in registry, Fly app exists
# 2. Deployment: Execute flyctl deploy with specified strategy
# 3. Health Gate: Poll /health endpoint until HEALTHY or timeout (5min)
# 4. Smoke Tests: Validate core API endpoints respond correctly
# 5. Diagnostics: Capture Fly.io logs and status if health gate fails
#
# DEPLOYMENT STRATEGIES:
# - immediate: All instances replaced simultaneously (fastest, brief downtime)
# - canary: New version on 1 instance, monitor before full rollout
# - rolling: Gradual instance replacement, maintains service availability
#
# SAFETY GATES:
# - Image validation: Manifest inspection ensures image exists before deploy
# - Health checks: Waits up to 5 minutes for /health endpoint (30-second polling)
# - Smoke tests: Validates /health and / endpoints return expected status codes
# - Automatic rollback: On health gate timeout, deployment terminates
#
# DESIGN PRINCIPLES:
# - Immutable deployments: Only deploys pre-built, pre-scanned images (no rebuilds)
# - Comprehensive validation: Checks image, app, health before marking success
# - Audit trail: Logs all validation steps, image SHA, deployment strategy
# - Fail-fast: Terminates on any critical error (missing image, unhealthy app)
#
# TROUBLESHOOTING:
# - Image not found: Re-run 1-ci-test.yml, or manually build with 'workflow_dispatch'
# - Health gate timeout: Check Fly.io logs (flyctl logs --app inventoryservice)
# - Smoke test failures: Verify Oracle Wallet mounted, database connectivity
# - Rollback: Re-run with previous image tag (automatic trigger has head_sha)
#
# DOWNSTREAM WORKFLOWS:
# - None: This is the final deployment pipeline; no further workflows follow
# =============================================================================

on:
  workflow_run:
    workflows: ["1ï¸âƒ£ Backend CI - Build & Test"]
    types:
      - completed
    branches:
      - main
  workflow_dispatch:
    inputs:
      image_tag:
        description: 'Docker image tag to deploy (commit SHA or "latest")'
        required: true
        default: 'latest'
        type: string
      deployment_strategy:
        description: 'Deployment strategy'
        required: true
        default: 'immediate'
        type: choice
        options:
          - immediate
          - canary
          - rolling

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Only run if the upstream workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    environment:
      name: production
      url: https://inventoryservice.fly.dev
    
    steps:
      # ---------------------------------------------------------------------
      # 1) Set deployment variables (manual or automatic)
      # ---------------------------------------------------------------------
      - name: ðŸ“‹ Set deployment variables
        id: vars
        run: |
          # Use manual input if workflow_dispatch, otherwise use commit SHA from upstream workflow
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            IMAGE_TAG="${{ inputs.image_tag }}"
            STRATEGY="${{ inputs.deployment_strategy }}"
          else
            IMAGE_TAG="${{ github.event.workflow_run.head_sha }}"
            STRATEGY="immediate"
          fi
          
          echo "image_tag=${IMAGE_TAG}" >> $GITHUB_OUTPUT
          echo "strategy=${STRATEGY}" >> $GITHUB_OUTPUT
          echo "ðŸ“¦ Deploying image: ckbuzin/inventory-service:${IMAGE_TAG}"
          echo "ðŸŽ¯ Strategy: ${STRATEGY}"
      # ---------------------------------------------------------------------
      # 2) Checkout repository (for fly.toml context)
      # ---------------------------------------------------------------------
      - name: Checkout code
        uses: actions/checkout@v4

      # ---------------------------------------------------------------------
      # 3) Validate Docker image exists
      # ---------------------------------------------------------------------
      - name: Validate Docker image
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/inventory-service:${{ steps.vars.outputs.image_tag }}"
          echo "Validating image: $IMAGE_NAME"
          
          # Login to Docker Hub to verify image
          echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin
          
          if docker manifest inspect "$IMAGE_NAME" > /dev/null 2>&1; then
            echo "âœ… Image found: $IMAGE_NAME"
            docker manifest inspect "$IMAGE_NAME" | jq -r '.manifests[0].digest'
          else
            echo "âŒ ERROR: Image not found in registry: $IMAGE_NAME"
            exit 1
          fi
      # ---------------------------------------------------------------------
      # 3) Install Fly CLI
      # ---------------------------------------------------------------------
      - name: Install Fly CLI
        uses: superfly/flyctl-actions/setup-flyctl@master

      # ---------------------------------------------------------------------
      # 4) Verify Fly.io app exists
      # ---------------------------------------------------------------------
      - name: Verify Fly app
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Verifying Fly.io app: inventoryservice"
          if flyctl status --app inventoryservice > /dev/null 2>&1; then
            echo "âœ… App exists"
            flyctl status --app inventoryservice
          else
            echo "âŒ ERROR: Fly.io app 'inventoryservice' not found"
            exit 1
          fi
      # ---------------------------------------------------------------------
      # 5) Deploy to Fly.io
      # ---------------------------------------------------------------------
      - name: Deploy to Fly.io
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          IMAGE_NAME="${{ secrets.DOCKER_USERNAME }}/inventory-service:${{ steps.vars.outputs.image_tag }}"
          
          echo "ðŸš€ Deploying to Fly.io..."
          echo "  App: inventoryservice"
          echo "  Image: $IMAGE_NAME"
          echo "  Strategy: ${{ steps.vars.outputs.strategy }}"
          
          flyctl deploy \
            --app inventoryservice \
            --image "$IMAGE_NAME" \
            --strategy "${{ steps.vars.outputs.strategy }}" \
            --remote-only \
            --wait-timeout 300
      # ---------------------------------------------------------------------
      # 6) Health check
      # ---------------------------------------------------------------------
      - name: Health check
        run: |
          echo "Waiting for deployment to be healthy..."
          sleep 15
          
          HEALTH_URL="https://inventoryservice.fly.dev/health"
          echo "Checking: $HEALTH_URL"
          
          MAX_ATTEMPTS=12
          ATTEMPT=1
          
          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS..."
            
            if curl -f -s -o /dev/null -w "%{http_code}" "$HEALTH_URL" | grep -q "200"; then
              echo "âœ… Health check passed!"
              curl -s "$HEALTH_URL" | jq -r '.' || echo "Response received (non-JSON)"
              break
            else
              if [ $ATTEMPT -eq $MAX_ATTEMPTS ]; then
                echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
                exit 1
              fi
              echo "Waiting 10 seconds before retry..."
              sleep 10
              ATTEMPT=$((ATTEMPT + 1))
            fi
          done
      # ---------------------------------------------------------------------
      # 7) Verify deployment
      # ---------------------------------------------------------------------
      - name: Verify deployment
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "Fetching deployment status..."
          flyctl status --app inventoryservice
          
          echo ""
          echo "Recent logs (last 50 lines):"
          flyctl logs --app inventoryservice -n 50 || echo "âš ï¸ Could not fetch logs"
      # ---------------------------------------------------------------------
      # 8) Smoke tests
      # ---------------------------------------------------------------------
      - name: Smoke tests
        run: |
          BASE_URL="https://inventoryservice.fly.dev"
          
          echo "Running smoke tests against: $BASE_URL"
          
          # Test 1: Health endpoint
          echo "Test 1: Health endpoint"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/health")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "  âœ… Health check: PASS"
          else
            echo "  âŒ Health check: FAIL (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          # Test 2: API root (should return 401 or redirect, not 500)
          echo "Test 2: API root"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "$BASE_URL/")
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "401" ] || [ "$HTTP_CODE" = "302" ]; then
            echo "  âœ… API root: PASS (HTTP $HTTP_CODE)"
          else
            echo "  âŒ API root: FAIL (HTTP $HTTP_CODE)"
            exit 1
          fi
          
          echo ""
          echo "âœ… All smoke tests passed!"
      # ---------------------------------------------------------------------
      # 9) Summary
      # ---------------------------------------------------------------------
      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **App:** \`inventoryservice\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Image:** \`${{ secrets.DOCKER_USERNAME }}/inventory-service:${{ steps.vars.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Strategy:** \`${{ steps.vars.outputs.strategy }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **URL:** https://inventoryservice.fly.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ Quick Links" >> $GITHUB_STEP_SUMMARY
          echo "- [Health Check](https://inventoryservice.fly.dev/health)" >> $GITHUB_STEP_SUMMARY
          echo "- [Fly.io Dashboard](https://fly.io/apps/inventoryservice)" >> $GITHUB_STEP_SUMMARY