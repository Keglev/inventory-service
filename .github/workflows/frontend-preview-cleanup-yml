name: Frontend Preview Cleanup (Koyeb)

on:
  pull_request:
    types: [closed]
    paths:
      - 'frontend/**'
      - '.github/workflows/frontend-preview.yml'
      - '.github/workflows/frontend-preview-cleanup.yml'

jobs:
  cleanup:
    runs-on: ubuntu-latest
    env:
      KOYEB_APP: ${{ secrets.KOYEB_APP }}
      SERVICE_NAME: frontend-pr-${{ github.event.pull_request.number }}

    steps:
      - name: Install Koyeb CLI
        run: |
          curl -fsSL https://developer.koyeb.com/install.sh | bash
          echo "${HOME}/.koyeb/bin" >> $GITHUB_PATH

      - name: Authenticate Koyeb
        run: koyeb login --api-token "${{ secrets.KOYEB_TOKEN }}"

      - name: Delete preview service (if exists)
        shell: bash
        run: |
          if koyeb service get "${KOYEB_APP}/${SERVICE_NAME}" >/dev/null 2>&1; then
            koyeb service delete "${KOYEB_APP}/${SERVICE_NAME}" --yes
            echo "Deleted ${KOYEB_APP}/${SERVICE_NAME}"
          else
            echo "No preview service found; nothing to delete."
          fi
