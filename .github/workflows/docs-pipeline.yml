name: Docs Pipeline – OpenAPI & Architecture

# =============================================================================
# Smart Supply Pro – Documentation Building & Publishing Pipeline
#
# PIPELINE ROLE: Automated documentation generation and artifact production
#
# PURPOSE:
# - Generate OpenAPI (Swagger/ReDoc) documentation from code annotations
# - Build architecture guides and markdown files into HTML documentation
# - Collect JaCoCo test coverage reports from CI builds
# - Produce 'docs-site' artifact for 2-deploy-ghpages.yml to publish
#
# TRIGGER MODES:
# 1. AUTOMATIC (via workflow_run):
#    - Triggered after 1-ci-test.yml succeeds
#    - Purpose: Rebuild docs whenever code changes (ensures freshness)
#    - Artifact: docs-site (consumed by 2-deploy-ghpages.yml)
#
# 2. ON-DEMAND (direct push to main):
#    - Triggered on changes to docs/, scripts/, or this workflow
#    - Purpose: Rapid documentation updates without waiting for CI
#    - Use case: Documentation-only PRs, emergency doc fixes
#
# ARTIFACTS PRODUCED:
# - docs-site: Complete documentation website (API docs, architecture, coverage)
#
# ARTIFACTS CONSUMED:
# - jacoco-html-{SHA}: JaCoCo coverage report from 1-ci-test.yml (optional)
#
# TOOLS & TECHNOLOGIES:
# - Redocly CLI: Converts OpenAPI YAML → ReDoc HTML (interactive API docs)
# - Pandoc: Converts Markdown → HTML (architecture guides, README files)
# - Lua filter: Custom Pandoc filter for mermaid diagram rendering
# - Bash scripts: Orchestrates document generation and artifact assembly
#
# DESIGN PRINCIPLES:
# - Dual-trigger: Responds to both code changes (via CI) and docs-only changes
# - Artifact accumulation: Preserves JaCoCo coverage from CI if not rebuilt
# - Offline-capable: All documentation is static HTML (no server-side processing)
# - Immutable builds: Same input always produces same output
#
# SCRIPTS INVOKED:
# - scripts/build-openapi-docs.sh: Generates OpenAPI documentation
# - scripts/build-architecture-docs.sh: Builds architecture guides
#
# TROUBLESHOOTING:
# - Missing JaCoCo artifact: Normal for docs-only pushes; skip JaCoCo step
# - Redocly CLI errors: Check OpenAPI YAML syntax in code annotations
# - Pandoc conversion failures: Review markdown syntax, mermaid diagrams
# - Large artifact size: Verify coverage HTML is compressed, no duplicate files
# =============================================================================
# A) After CI: for code changes
  workflow_run:
    workflows: ["1️⃣ Backend CI - Build & Test"]
    types: [completed]
# B) Directly on docs-only changes
  push:
    branches: [ main ]
    paths:
      - 'docs/**'
      - 'scripts/**'
      - '.github/workflows/docs-pipeline.yml'

permissions:
  contents: write
  actions: read

jobs:
  build-docs:
    # For workflow_run: only if CI succeeded
    # For push: always (we'll treat it as docs-only)
    runs-on: ubuntu-latest
    if: >
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')
      || github.event_name == 'push'

    steps:
      # A) Checkout for workflow_run (after CI)
      - name: Checkout (from CI head_sha)
        if: github.event_name == 'workflow_run'
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
      # B) Checkout for direct docs push
      - name: Checkout (push docs)
        if: github.event_name == 'push'
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2) Detect project root (root vs backend/)
      - name: Detect project root
        id: where
        run: |
          if [ -f "pom.xml" ] && [ -d "docs" ]; then
            echo "dir=." >> $GITHUB_OUTPUT
          elif [ -f "backend/pom.xml" ] && [ -d "backend/docs" ]; then
            echo "dir=backend" >> $GITHUB_OUTPUT
          else
            echo "::error::No suitable project root found (no pom.xml + docs/)"
            exit 1
          fi
          echo "Using project directory:"
          cat $GITHUB_OUTPUT

      # 3) Download JaCoCo artifact from CI (name matches ci-test.yml)
      - name: Download JaCoCo artifact
        if: github.event_name == 'workflow_run'
        uses: actions/download-artifact@v4
        with:
          name: jacoco-html-${{ github.event.workflow_run.head_sha }}
          path: ${{ steps.where.outputs.dir }}/target/site/jacoco
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Check JaCoCo artifact
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          JACOCO_DIR="$PROJECT_DIR/target/site/jacoco"
          
          if [ -d "$JACOCO_DIR" ] && [ "$(ls -A $JACOCO_DIR)" ]; then
            echo "✅ JaCoCo artifact found at $JACOCO_DIR"
            echo "Files: $(ls -1 $JACOCO_DIR | head -5)"
          else
            echo "⚠️  JaCoCo artifact not found or empty"
            echo "Event: ${{ github.event_name }}"
            if [ "${{ github.event_name }}" = "push" ]; then
              echo "Note: Direct push event (docs-only change) - JaCoCo artifact won't be available"
              echo "JaCoCo is only available when workflow_run is triggered after CI succeeds"
            fi
          fi

      # 4) Node + ReDoc CLI (for OpenAPI → ReDoc)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install ReDoc CLI
        run: npm install -g @redocly/cli

      # 5) Pandoc (for Markdown → HTML)
      - name: Install pandoc
        run: |
          sudo apt-get update
          sudo apt-get install -y pandoc

      # 6) Build OpenAPI docs & copy coverage (your script)
      - name: Build OpenAPI docs & copy coverage
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          bash "$PROJECT_DIR/scripts/build-openapi-docs.sh" "$PROJECT_DIR"

      # 7) Build architecture & other markdown (your script with Lua filter)
      - name: Build architecture & markdown docs
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          bash "$PROJECT_DIR/scripts/build-architecture-docs.sh" "$PROJECT_DIR"

      # 8) Sanity check
      - name: Verify docs tree
        run: |
          PROJECT_DIR="${{ steps.where.outputs.dir }}"
          OUTPUT_DIR="$PROJECT_DIR/target/docs"
          echo "Files in $OUTPUT_DIR: $(find "$OUTPUT_DIR" -type f | wc -l || echo 0)"
          du -sh "$OUTPUT_DIR" || echo "(size unavailable)"

      # 9) Upload docs-site artifact
      - name: Upload docs-site artifact
        uses: actions/upload-artifact@v4
        with:
          name: docs-site
          path: ${{ steps.where.outputs.dir }}/target/docs
