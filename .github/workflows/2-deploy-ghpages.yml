# =============================================================================
# Smart Supply Pro â€“ Documentation Publishing Pipeline
#
# PIPELINE ROLE: Automated documentation deployment to GitHub Pages
#
# PURPOSE:
# - Publish generated documentation artifacts to gh-pages branch automatically
# - Maintain live API documentation, architecture guides, and test coverage reports
# - Ensure documentation stays in sync with code changes and CI builds
#
# ARTIFACTS CONSUMED:
# - docs-site (from docs-pipeline.yml) â€“ Built documentation with OpenAPI specs
# - jacoco-html-{SHA} (from 1-ci-test.yml) â€“ Test coverage reports
#
# PUBLISHING STRATEGY:
# - Preserves gh-pages branch history (shallow checkout, force-push with commit)
# - Incremental updates: Only commits if documentation changed
# - Coverage preservation: Retains JaCoCo reports if current build omits them
# - Immutable artifact names: Uses commit SHA to avoid race conditions
#
# SECURITY & COMPLIANCE:
# - Requires successful docs-pipeline.yml completion (no orphaned publishes)
# - Git author: github-actions[bot] for audit trail
# - No code execution on gh-pages branch (static content only)
#
# DESIGN PRINCIPLES:
# - Upstream-only: Consumes artifacts; does not re-generate them
# - Artifact preservation: Maintains coverage history if skipped in current build
# - Idempotent commits: No-op if documentation unchanged (skips unnecessary pushes)
#
# TROUBLESHOOTING:
# - If artifact download fails: Verify docs-pipeline.yml ran successfully
# - If gh-pages push fails: Check GitHub token permissions (contents: write required)
# - If coverage missing: Re-run 1-ci-test.yml to regenerate JaCoCo artifact
# =============================================================================
name: 2ï¸âƒ£ Deploy Docs to GitHub Pages
on:
  workflow_run:
    workflows: ["Docs Pipeline â€“ OpenAPI & Architecture"]
    types: [completed]

permissions:
  contents: write
  actions: read

concurrency:
  group: ci-${{ github.ref }}
  cancel-in-progress: true
  
# Needed to checkout gh-pages and push updates
jobs:
  deploy-ghpages:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    # Checkout gh-pages branch for publishing
    steps:
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0
    # Download docs-site artifact from docs-pipeline.yml
      - name: Download docs-site artifact
        uses: actions/download-artifact@v4
        with:
          name: docs-site
          path: docs-site
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
      # Sync docs-site contents into gh-pages root
      - name: Sync docs-site into gh-pages
        run: |
          # Debug: show what was downloaded
          echo "Contents of docs-site directory:"
          ls -la docs-site/ || echo "docs-site directory not found"
          echo ""
          echo "Contents with find:"
          find docs-site -type f | head -20 || echo "No files found"
          echo ""
          
          # Preserve existing coverage if not included in this build
          PRESERVE_COVERAGE=false
          if [ ! -d "docs-site/backend/coverage" ] && [ -d "backend/coverage" ]; then
            echo "â„¹ï¸  JaCoCo coverage not in current build - preserving existing coverage"
            mkdir -p /tmp/coverage-backup
            cp -R backend/coverage /tmp/coverage-backup/
            PRESERVE_COVERAGE=true
          fi
          
          # keep .git and .github, remove everything else
          find . -mindepth 1 -maxdepth 1 ! -name '.git' ! -name '.github' ! -name 'docs-site' -exec rm -rf {} +

          # Copy docs-site contents to root
          if [ -d "docs-site" ] && [ "$(ls -A docs-site)" ]; then
            cp -R docs-site/* .
            rm -rf docs-site
            echo "âœ… Copied docs-site to root"
          else
            echo "âŒ docs-site directory is empty or missing"
            exit 1
          fi
          
          # Restore coverage if we preserved it
          if [ "$PRESERVE_COVERAGE" = true ]; then
            mkdir -p backend/coverage
            cp -R /tmp/coverage-backup/coverage/* backend/coverage/
            echo "âœ… Restored existing JaCoCo coverage"
            rm -rf /tmp/coverage-backup
          fi
      # Commit and push changes to gh-pages branch
      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if git status --porcelain | grep .; then
            git add .
            git commit -m "docs: publish docs-site from workflow_run ${{ github.event.workflow_run.id }}"
            git push origin gh-pages
            echo "âœ… Documentation published successfully"
          else
            echo "âœ… No changes to publish"
          fi
      # Job summary for GitHub Actions UI
      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ“š GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`gh-pages\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Site:** https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/" >> $GITHUB_STEP_SUMMARY
