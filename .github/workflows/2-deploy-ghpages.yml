name: 2ï¸âƒ£ Deploy Docs to GitHub Pages

# =============================================================================
# Smart Supply Pro - GitHub Pages Deployment
#
# Enterprise documentation publishing pipeline:
# - Purpose: Deploy generated HTML artifacts to gh-pages branch.
# - Triggered by: Successful completion of 1-ci-test.yml workflow.
# - Artifacts published:
#     * JaCoCo test coverage reports â†’ /coverage/backend/
#     * ReDoc API documentation â†’ /api/
# - Design: Isolated branch strategy (gh-pages) prevents pollution of main.
#
# Publishing workflow:
#   1-ci-test.yml â†’ uploads artifacts
#   2-deploy-ghpages.yml (this file) â†’ downloads & commits to gh-pages
# =============================================================================

on:
  workflow_run:
    workflows: ["1ï¸âƒ£ Backend CI - Build & Test"]
    types: [completed]
    branches: [main]

permissions:
  contents: write
  actions: read

jobs:
  deploy-ghpages:
    # Only deploy if the upstream workflow succeeded
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    
    steps:
      # ---------------------------------------------------------------------
      # 1) Checkout gh-pages branch
      # ---------------------------------------------------------------------
      - name: Checkout gh-pages branch
        uses: actions/checkout@v4
        with:
          ref: gh-pages
          token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------------
      # 2) Download JaCoCo coverage artifact from upstream workflow
      # ---------------------------------------------------------------------
      - name: Download JaCoCo artifact
        uses: actions/download-artifact@v4
        with:
          name: jacoco-html-${{ github.event.workflow_run.head_sha }}
          path: coverage/backend/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}

      # ---------------------------------------------------------------------
      # 3) Download ReDoc API documentation (optional, may not exist)
      # ---------------------------------------------------------------------
      - name: Download ReDoc artifact
        uses: actions/download-artifact@v4
        with:
          name: redoc-html
          path: api/
          run-id: ${{ github.event.workflow_run.id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
        continue-on-error: true

      # ---------------------------------------------------------------------
      # 4) Create index page for navigation (if not exists)
      # ---------------------------------------------------------------------
      - name: Create GitHub Pages index
        run: |
          if [ ! -f "index.html" ]; then
            cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Smart Supply Pro - Documentation</title>
            <style>
              body {
                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
                max-width: 800px;
                margin: 60px auto;
                padding: 20px;
                line-height: 1.6;
                color: #333;
              }
              h1 { color: #0366d6; }
              .card {
                border: 1px solid #e1e4e8;
                border-radius: 6px;
                padding: 20px;
                margin: 20px 0;
                background: #f6f8fa;
              }
              a { color: #0366d6; text-decoration: none; }
              a:hover { text-decoration: underline; }
              .timestamp {
                color: #586069;
                font-size: 14px;
                margin-top: 30px;
                text-align: center;
              }
            </style>
          </head>
          <body>
            <h1>ðŸ“š Smart Supply Pro - Documentation</h1>
            
            <div class="card">
              <h2>ðŸ§ª Test Coverage</h2>
              <p>View backend test coverage reports generated by JaCoCo.</p>
              <a href="/inventory-service/coverage/backend/index.html">â†’ View Coverage Report</a>
            </div>
            
            <div class="card">
              <h2>ðŸ“– API Documentation</h2>
              <p>Interactive REST API documentation powered by ReDoc.</p>
              <a href="/inventory-service/api/index.html">â†’ View API Docs</a>
            </div>
            
            <div class="timestamp">
              Last updated: <span id="timestamp"></span>
              <script>
                document.getElementById('timestamp').textContent = new Date().toLocaleString();
              </script>
            </div>
          </body>
          </html>
          EOF
            echo "âœ… Created index.html"
          else
            echo "â„¹ï¸  index.html already exists"
          fi

      # ---------------------------------------------------------------------
      # 5) Commit and push to gh-pages
      # ---------------------------------------------------------------------
      - name: Commit and push to gh-pages
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Stage all documentation artifacts
          git add coverage/ api/ index.html
          
          # Check if there are changes to commit
          if git diff --cached --quiet; then
            echo "âœ… No changes to publish"
          else
            TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
            COMMIT_SHA=$(echo "${{ github.event.workflow_run.head_sha }}" | cut -c1-7)
            
            git commit -m "docs: update coverage & API docs [$TIMESTAMP]

            Source commit: $COMMIT_SHA
            Workflow: ${{ github.event.workflow_run.id }}"
            
            git push origin gh-pages
            echo "âœ… Documentation published successfully"
          fi

      # ---------------------------------------------------------------------
      # 6) Summary
      # ---------------------------------------------------------------------
      - name: Job Summary
        if: always()
        run: |
          echo "## ðŸ“š GitHub Pages Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`gh-pages\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Commit:** \`${{ github.event.workflow_run.head_sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Coverage:** [View Report](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/coverage/backend/)" >> $GITHUB_STEP_SUMMARY
          echo "- **API Docs:** [View API](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/api/)" >> $GITHUB_STEP_SUMMARY
