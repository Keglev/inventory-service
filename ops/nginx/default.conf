# -----------------------------------------------------------------------------
# Smart Supply Pro — Frontend (Vite SPA) : Nginx vhost
# Purpose:
#   - Serve the compiled SPA and static assets on port 8080
#   - Provide SPA fallback for client-side routing (/dashboard, /settings, …)
#   - Apply aggressive caching to content-hashed assets under /assets/
#   - Ensure index.html is never cached (fresh shell + correct asset versions)
# -----------------------------------------------------------------------------
server {
  listen 8080 default_server;
  server_name _;

  # Root directory produced by the Vite build stage
  root   /usr/share/nginx/html;
  index  index.html;

  # ---- SPA fallback ----------------------------------------------------------
  # Try the exact file, then a directory index, and finally fall back to index.html
  # This enables BrowserRouter-style deep links to load the app shell.
  location / {
    try_files $uri $uri/ /index.html;
  }

  # ---- Static assets (content-hashed) ---------------------------------------
  # Vite outputs hashed filenames under /assets/. Safe to cache "forever".
  location /assets/ {
    try_files $uri =404;
    expires 1y;
    add_header Cache-Control "public, immutable" always;
  }

  # ---- App shell (never cached) ---------------------------------------------
  # index.html must remain uncached so clients always receive fresh asset URLs.
  location = /index.html {
    add_header Cache-Control "no-cache" always;
  }
}
