# -----------------------------------------------------------------------------
# Smart Supply Pro — Frontend (Vite SPA) : Nginx vhost
# Purpose:
#   - Serve the compiled SPA and static assets on port 8080
#   - Provide SPA fallback for client-side routing (/dashboard, /settings, …)
#   - Apply aggressive caching to content-hashed assets under /assets/
#   - Ensure index.html is never cached (fresh shell + correct asset versions)
# -----------------------------------------------------------------------------
server {
  listen 8080 default_server;
  server_name _;

  # Root directory produced by the Vite build stage
  root   /usr/share/nginx/html;
  index  index.html;

  # ---- SPA fallback ----------------------------------------------------------
  # Try the exact file, then a directory index, and finally fall back to index.html
  # This enables BrowserRouter-style deep links to load the app shell.
  location / {
    try_files $uri $uri/ /index.html;
  }

  # ---- API reverse proxy (same-origin) -------------------------------------
  # Purpose:
  #   - Make SPA calls to /api/* first-party (no 3rd-party cookie issues)
  #   - Forward to the Fly backend (HTTPS) with SNI, preserving path/query
  #   - Rewrite Set-Cookie Domain to the SPA domain so the browser stores the cookie
  #
  # Requirements:
  #   - Frontend must call /api/* (e.g., VITE_API_BASE=/api)
  #   - Koyeb service exposes container port 8080 publicly at path "/"
  #
  location /api/ {
    # Upstream: Fly API (HTTPS). $request_uri keeps path+query after /api
    proxy_pass https://inventoryservice.fly.dev$request_uri;

    # Let Nginx present the correct SNI when talking TLS to upstream
    proxy_ssl_server_name on;
    proxy_ssl_name inventoryservice.fly.dev;

    # Forward client/proxy info
    proxy_set_header Host inventoryservice.fly.dev;     # backend expects its own host
    proxy_set_header X-Forwarded-Host $host;            # original FE host (useful for logs)
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

    # Ensure cookies set by the API become first-party on the FE domain
    # $host = current public host (e.g., inventory-service.koyeb.app)
    proxy_cookie_domain inventoryservice.fly.dev $host;

    # (optional) keep upstream Location headers intact
    proxy_redirect off;

    # Reasonable proxy buffers/timeouts for APIs
    proxy_connect_timeout 5s;
    proxy_send_timeout 30s;
    proxy_read_timeout 30s;

    # Allow JSON posts up to ~2MB (adjust if needed)
    client_max_body_size 2m;
  }
  # ---------------------------------------------------------------------------

  # ---- Static assets (content-hashed) ---------------------------------------
  # Vite outputs hashed filenames under /assets/. Safe to cache "forever".
  location /assets/ {
    try_files $uri =404;
    expires 1y;
    add_header Cache-Control "public, immutable" always;
  }

  # ---- App shell (never cached) ---------------------------------------------
  # index.html must remain uncached so clients always receive fresh asset URLs.
  location = /index.html {
    add_header Cache-Control "no-cache" always;
  }
}
